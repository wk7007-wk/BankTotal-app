<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>BankTotal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#121212;color:#e0e0e0;min-height:100vh;overflow-x:hidden}
.header{background:#1a1a2e;padding:20px 16px;text-align:center;position:sticky;top:0;z-index:10;position:relative}
.refresh-btn{position:absolute;top:16px;right:12px;background:#333;border:none;color:#4fc3f7;font-size:20px;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
.refresh-btn:active{background:#444}
.refresh-btn.spinning{animation:spin .6s linear}
.subtotal-row{color:#aaa;font-size:14px;margin-bottom:2px;display:none}
.subtotal-row.show{display:block}
.subtotal-val{font-size:18px;color:#bbb}
.total-label{color:#888;font-size:14px;margin-top:4px}
.total-val{font-size:32px;font-weight:bold;color:#fff;margin:4px 0}
.last-update{color:#666;font-size:12px}
.tabs{display:flex;background:#1e1e30;overflow-x:auto;position:sticky;top:0;z-index:9}
.tab{flex:1;min-width:60px;padding:10px 8px;text-align:center;font-size:13px;color:#888;border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap}
.tab.active{color:#4fc3f7;border-bottom-color:#4fc3f7}
.section{display:none;padding:12px}
.section.active{display:block}
.card{background:#1e1e30;border-radius:10px;padding:12px;margin-bottom:8px}
.card-row{display:flex;justify-content:space-between;align-items:center}
.bank-name{font-size:13px;color:#888;min-width:40px}
.alias{font-size:15px;color:#e0e0e0}
.balance{font-size:18px;font-weight:bold;color:#4fc3f7;text-align:right}
.balance.negative{color:#ef5350}
.inactive .balance{opacity:.5}
.inactive .alias{opacity:.5}
.last-tx{font-size:11px;color:#666;margin-top:4px}
.active-badge{font-size:10px;padding:2px 6px;border-radius:8px;background:#4caf5033;color:#4caf50}
.inactive .active-badge{background:#99999933;color:#999}
.filter-row{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.filter-btn{padding:6px 12px;border-radius:16px;border:1px solid #333;background:transparent;color:#aaa;font-size:12px;cursor:pointer}
.filter-btn.active{background:#4fc3f7;color:#121212;border-color:#4fc3f7}
.tx-group{margin-bottom:12px}
.tx-date{font-size:12px;color:#666;padding:4px 0;border-bottom:1px solid #222}
.tx-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #1a1a1a}
.tx-left{display:flex;flex-direction:column;gap:2px}
.tx-bank{font-size:11px;color:#888}
.tx-cp{font-size:13px;color:#ccc}
.tx-time{font-size:10px;color:#555}
.tx-amount{font-size:15px;font-weight:bold;text-align:right}
.tx-amount.in{color:#4caf50}
.tx-amount.out{color:#ef5350}
.tx-balance{font-size:10px;color:#666;text-align:right}
.tx-item.excluded{opacity:.35}
.tx-item.excluded .tx-amount{text-decoration:line-through}
.tx-excluded-tag{font-size:9px;color:#666;background:#333;padding:1px 5px;border-radius:4px;margin-left:4px}
.cat-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #1a1a1a}
.cat-name{font-size:14px;color:#ccc}
.cat-count{font-size:11px;color:#666}
.cat-amount{font-size:16px;font-weight:bold;color:#ef5350}
.log-item{padding:6px 0;border-bottom:1px solid #1a1a1a;font-family:monospace;font-size:12px}
.log-ts{color:#555}
.log-tag{font-weight:bold;margin:0 4px}
.log-tag.tx{color:#4caf50}
.log-tag.parse{color:#4fc3f7}
.log-tag.err{color:#ef5350}
.log-tag.sys{color:#ff9800}
.log-msg{color:#ccc}
.perm-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#1e1e30;border-radius:10px;margin-bottom:8px}
.perm-name{font-size:14px;color:#ccc}
.perm-status{font-size:13px;font-weight:bold;padding:4px 10px;border-radius:12px}
.perm-status.on{background:#4caf5033;color:#4caf50}
.perm-status.off{background:#ef535033;color:#ef5350;cursor:pointer}
.summary-box{background:#1e1e30;border-radius:10px;padding:16px;margin-bottom:12px;text-align:center}
.summary-label{font-size:12px;color:#888}
.summary-val{font-size:24px;font-weight:bold;color:#4fc3f7;margin-top:4px}
.summary-row{display:flex;gap:8px}
.summary-row .summary-box{flex:1}
.empty{text-align:center;color:#555;padding:40px 0;font-size:14px}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.version{text-align:center;color:#444;font-size:11px;padding:20px 0}
.settle-tag{font-size:10px;padding:1px 5px;border-radius:4px;margin-left:4px}
.settle-tag.manual{color:#4fc3f7;background:#4fc3f722}
.settle-tag.auto{color:#ff9800;background:#ff980022}
.predicted-bal{font-size:11px;color:#888;float:right}
.ai-msgs{max-height:300px;overflow-y:auto;margin:8px 0}
.ai-msg{padding:8px 12px;border-radius:10px;margin-bottom:6px;font-size:13px;line-height:1.6;white-space:pre-wrap}
.ai-msg.user{background:#4fc3f722;color:#4fc3f7;text-align:right}
.ai-msg.bot{background:#2a2a40;color:#e0e0e0}
.ai-input-row{display:flex;gap:6px}
.ai-input{flex:1;padding:10px;background:#2a2a40;border:1px solid #333;border-radius:8px;color:#e0e0e0;font-size:14px;outline:none}
.ai-send{padding:10px 16px;background:#4fc3f7;color:#121212;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer}
.ai-send:disabled{opacity:.4}
</style>
</head>
<body>

<div class="header" id="header">
    <button class="refresh-btn" id="refreshBtn" onclick="doRefresh()">&#x21bb;</button>
    <div class="subtotal-row" id="subtotalRow">
        소계 <span class="subtotal-val" id="subtotalVal">0</span>
    </div>
    <div class="total-label">합계</div>
    <div class="total-val" id="totalVal">0</div>
    <div class="last-update" id="lastUpdate">마지막 업데이트: --</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('accounts')">계좌</div>
    <div class="tab" onclick="showTab('ledger')">가계부</div>
    <div class="tab" onclick="showTab('settle')">정산</div>
</div>

<div class="section active" id="sec-accounts">
    <div id="accountList"></div>
</div>

<div class="section" id="sec-ledger">
    <div class="filter-row" id="ledgerFilter">
        <div class="filter-btn active" onclick="setLedgerFilter('out')">출금</div>
        <div class="filter-btn" onclick="setLedgerFilter('in')">입금</div>
        <div class="filter-btn" onclick="setLedgerFilter('all')">전체</div>
        <div class="filter-btn" onclick="setLedgerFilter('cat')">카테고리</div>
    </div>
    <div id="ledgerSummary"></div>
    <div id="ledgerContent"></div>
</div>

<div class="section" id="sec-settle">
    <div id="settleSummary"></div>
    <div id="settleContent"></div>
    <div style="margin-top:12px">
        <div class="ai-msgs" id="aiMsgs"></div>
        <div class="ai-input-row">
            <input type="file" id="aiFileInput" accept="image/*" style="display:none" onchange="analyzeImage(this)">
            <button onclick="loadLatestImage()" style="padding:8px 10px;background:#2a2a40;border:1px solid #333;border-radius:8px;color:#aaa;font-size:16px;cursor:pointer">&#128247;</button>
            <input class="ai-input" id="aiInput" placeholder="항목등록, 재무질문, 사진분석..." onkeydown="if(event.key==='Enter')askAi()" style="font-size:13px;padding:8px">
            <button class="ai-send" id="aiSendBtn" onclick="askAi()" style="padding:8px 12px;font-size:13px">AI</button>
        </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:6px">
        <div class="card" onclick="showTab('logs')" style="cursor:pointer;text-align:center;font-size:11px;color:#4fc3f7;flex:1;padding:8px">로그</div>
        <div class="card" onclick="showTab('perms')" style="cursor:pointer;text-align:center;font-size:11px;color:#4fc3f7;flex:1;padding:8px">권한</div>
        <div class="card" onclick="promptAiKey()" style="cursor:pointer;text-align:center;font-size:11px;color:#888;flex:1;padding:8px" id="aiKeyBtn">API키</div>
    </div>
</div>

<div class="section" id="sec-logs">
    <div class="filter-row" id="logFilter">
        <div class="filter-btn active" onclick="setLogFilter('all')">전체</div>
        <div class="filter-btn" onclick="setLogFilter('[TX]')">TX</div>
        <div class="filter-btn" onclick="setLogFilter('[PARSE]')">PARSE</div>
        <div class="filter-btn" onclick="setLogFilter('[ERR]')">ERR</div>
        <div class="filter-btn" onclick="setLogFilter('[SYS]')">SYS</div>
    </div>
    <div id="logContent"></div>
</div>

<div class="section" id="sec-perms">
    <div id="permContent"></div>
</div>

<div class="version" id="versionInfo">BankTotal Web Dashboard</div>

<script>
const FB='https://poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app';
const fmt=n=>{if(n==null)return'0';const s=n<0;const a=Math.abs(n);return(s?'-':'')+a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')};
const tsFmt=ts=>{const d=new Date(ts);return`${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`};
const dateFmt=ts=>{const d=new Date(ts);return`${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`};
const timeFmt=ts=>{const d=new Date(ts);return`${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`};

let accounts={},transactions=[],logs=[],settleManual=[],settleAuto=[],aiRules={},currentTab='accounts',ledgerMode='out',logFilterTag='all';

// --- 거래 마킹: 이체/중복은 _excluded + _reason 표시, 합산 제외 ---
function markTransactions(txList){
    const sorted=[...txList].sort((a,b)=>(a.ts||0)-(b.ts||0));
    // 1) 동일계좌 이체 (동일금액+5분내+다른은행+입출금반대)
    for(let i=0;i<sorted.length;i++){
        for(let j=i+1;j<sorted.length;j++){
            const a=sorted[i],b=sorted[j];
            if(Math.abs((a.ts||0)-(b.ts||0))>300000)break;
            if(a.amount===b.amount&&a.type!==b.type&&a.bank!==b.bank&&!a._excluded&&!b._excluded){
                a._excluded=true;a._reason='이체';
                b._excluded=true;b._reason='이체';
                break;
            }
        }
    }
    // 2) 중복 (같은 은행+금액+타입, 60초 이내)
    for(let i=0;i<sorted.length;i++){
        if(sorted[i]._excluded)continue;
        for(let j=i+1;j<sorted.length;j++){
            const a=sorted[i],b=sorted[j];
            if(Math.abs((a.ts||0)-(b.ts||0))>60000)break;
            if(a.bank===b.bank&&a.amount===b.amount&&a.type===b.type&&!b._excluded){
                b._excluded=true;b._reason='중복';
            }
        }
    }
    return sorted;
}

// --- 탭 관리 ---
function showTab(name){
    currentTab=name;
    document.querySelectorAll('.tab').forEach((t,i)=>{
        const tabs=['accounts','ledger','settle'];
        t.classList.toggle('active',tabs[i]===name||(name==='logs'&&i===2)||(name==='perms'&&i===2));
    });
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('sec-'+name).classList.add('active');
    if(name==='perms')renderPermissions();
    if(name==='settle')renderSettle();
}

// --- Firebase SSE ---
function connectSSE(path,handler){
    const es=new EventSource(FB+path+'.json');
    es.onmessage=e=>{
        try{handler(JSON.parse(e.data));}catch(ex){}
    };
    es.onerror=()=>{setTimeout(()=>connectSSE(path,handler),5000);es.close()};
    // 초기 로드 (SSE put 이벤트 전에 REST로 즉시 로드)
    fetch(FB+path+'.json').then(r=>r.json()).then(d=>{if(d)handler(d);}).catch(()=>{});
}

function initSSE(){
    connectSSE('/banktotal/accounts',d=>{accounts=d||{};renderAccounts()});
    connectSSE('/banktotal/transactions',d=>{
        if(!d){transactions=[];renderLedger();return;}
        transactions=markTransactions(Object.values(d)).sort((a,b)=>(b.ts||0)-(a.ts||0));
        renderLedger();
    });
    connectSSE('/banktotal/logs',d=>{
        if(!d){logs=[];renderLogs();return;}
        logs=Object.values(d).sort((a,b)=>(b.ts||0)-(a.ts||0));
        renderLogs();
    });
    connectSSE('/banktotal/settle/manual',d=>{
        settleManual=d?Object.entries(d).map(([k,v])=>({...v,_id:k})):[];
        if(currentTab==='settle')renderSettle();
    });
    connectSSE('/banktotal/settle/auto',d=>{
        settleAuto=d?Object.entries(d).map(([k,v])=>({...v,_id:k})):[];
        if(currentTab==='settle')renderSettle();
    });
    fetch(FB+'/banktotal/ai_rules.json').then(r=>r.json()).then(d=>{if(d)aiRules=d}).catch(()=>{});
}

// --- NativeBridge 지원 (앱 내 WebView) ---
function loadFromNative(){
    if(typeof NativeBridge==='undefined')return false;
    try{
        const json=NativeBridge.getAccountsJson();
        if(json){
            const list=JSON.parse(json);
            renderNativeAccounts(list);
        }
    }catch(e){}
    return true;
}

function renderNativeAccounts(list){
    let total=0,subtotal=0;
    list.forEach(a=>{
        if(a.isActive){total+=a.balance;if(a.balance>=0)subtotal+=a.balance;}
    });
    document.getElementById('totalVal').textContent=fmt(total);
    if(subtotal!==total){
        document.getElementById('subtotalRow').classList.add('show');
        document.getElementById('subtotalVal').textContent=fmt(subtotal);
    }else{
        document.getElementById('subtotalRow').classList.remove('show');
    }
    const lastUp=Math.max(...list.map(a=>a.lastUpdated||0));
    document.getElementById('lastUpdate').textContent=lastUp>0?`마지막 업데이트: ${tsFmt(lastUp)}`:'마지막 업데이트: --';

    const html=list.map(a=>{
        const inactive=!a.isActive?'inactive':'';
        const balCls=a.balance<0?'balance negative':'balance';
        const lastTx=a.lastTransactionType?(
            `${a.lastTransactionType} ${fmt(a.lastTransactionAmount)} · ${tsFmt(a.lastUpdated)}`
        ):(a.lastUpdated>0?tsFmt(a.lastUpdated):'');
        const badge=a.isActive?'합산 포함':'합산 제외';
        const badgeCls=a.isActive?'active-badge':'active-badge';
        return`<div class="card ${inactive}">
            <div class="card-row"><div><span class="bank-name">${a.bankName}</span> <span class="alias">${a.displayName||a.accountNumber}</span></div><div class="${balCls}">${fmt(a.balance)}</div></div>
            <div class="card-row" style="margin-top:4px"><span class="last-tx">${lastTx}</span><span class="${badgeCls}">${badge}</span></div>
        </div>`;
    }).join('');
    document.getElementById('accountList').innerHTML=html||'<div class="empty">계좌 없음</div>';
}

// --- 계좌 렌더링 (Firebase) ---
function renderAccounts(){
    const list=Object.values(accounts);
    if(!list.length){
        document.getElementById('accountList').innerHTML='<div class="empty">계좌 없음</div>';
        document.getElementById('totalVal').textContent='0';
        return;
    }
    let total=0;
    list.forEach(a=>total+=a.balance||0);
    document.getElementById('totalVal').textContent=fmt(total);

    const lastUp=Math.max(...list.map(a=>a.updated||0));
    document.getElementById('lastUpdate').textContent=lastUp>0?`마지막 업데이트: ${tsFmt(lastUp)}`:'마지막 업데이트: --';

    const html=list.sort((a,b)=>(a.bank||'').localeCompare(b.bank||'')).map(a=>{
        const balCls=a.balance<0?'balance negative':'balance';
        return`<div class="card">
            <div class="card-row"><div><span class="bank-name">${a.bank||''}</span> <span class="alias">${a.account||''}</span></div><div class="${balCls}">${fmt(a.balance)}</div></div>
            <div class="card-row" style="margin-top:4px"><span class="last-tx">${a.updated?tsFmt(a.updated):''}</span></div>
        </div>`;
    }).join('');
    document.getElementById('accountList').innerHTML=html;
}

// --- 가계부 렌더링 ---
function setLedgerFilter(mode){
    ledgerMode=mode;
    document.querySelectorAll('#ledgerFilter .filter-btn').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    renderLedger();
}

function renderLedger(){
    const el=document.getElementById('ledgerContent');
    const sum=document.getElementById('ledgerSummary');
    if(!transactions.length){el.innerHTML='<div class="empty">거래 내역 없음</div>';sum.innerHTML='';return;}

    let filtered=transactions;
    if(ledgerMode==='in')filtered=transactions.filter(t=>t.type==='입금');
    if(ledgerMode==='out')filtered=transactions.filter(t=>t.type==='출금');

    if(ledgerMode==='cat'){
        renderCategory(transactions.filter(t=>t.type==='출금'&&!t._excluded));
        return;
    }

    // 요약 (제외 항목 합산 안 함)
    const totalIn=transactions.filter(t=>t.type==='입금'&&!t._excluded).reduce((s,t)=>s+(t.amount||0),0);
    const totalOut=transactions.filter(t=>t.type==='출금'&&!t._excluded).reduce((s,t)=>s+(t.amount||0),0);
    sum.innerHTML=`<div class="summary-row">
        <div class="summary-box"><div class="summary-label">입금</div><div class="summary-val" style="color:#4caf50">+${fmt(totalIn)}</div></div>
        <div class="summary-box"><div class="summary-label">출금</div><div class="summary-val" style="color:#ef5350">-${fmt(totalOut)}</div></div>
    </div>`;

    // 날짜별 그룹
    const grouped={};
    filtered.forEach(t=>{
        const d=dateFmt(t.ts);
        if(!grouped[d])grouped[d]=[];
        grouped[d].push(t);
    });

    let html='';
    for(const[date,txs]of Object.entries(grouped)){
        const dayTotal=txs.filter(t=>!t._excluded).reduce((s,t)=>s+(t.type==='입금'?t.amount:-t.amount),0);
        html+=`<div class="tx-group"><div class="tx-date">${date}  <span style="color:${dayTotal>=0?'#4caf50':'#ef5350'}">${dayTotal>=0?'+':''}${fmt(dayTotal)}</span></div>`;
        txs.forEach(t=>{
            const isIn=t.type==='입금';
            const excCls=t._excluded?'excluded':'';
            const tag=t._reason?`<span class="tx-excluded-tag">${t._reason}</span>`:'';
            html+=`<div class="tx-item ${excCls}">
                <div class="tx-left"><span class="tx-cp">${t.counterparty||t.bank||''}${tag}</span><span class="tx-time">${timeFmt(t.ts)} ${t.bank||''}</span></div>
                <div><div class="tx-amount ${isIn?'in':'out'}">${isIn?'+':'-'}${fmt(t.amount)}</div><div class="tx-balance">잔액 ${fmt(t.balance)}</div></div>
            </div>`;
        });
        html+='</div>';
    }
    el.innerHTML=html;
}

function renderCategory(withdrawals){
    const sum=document.getElementById('ledgerSummary');
    const el=document.getElementById('ledgerContent');
    if(!withdrawals.length){el.innerHTML='<div class="empty">출금 내역 없음</div>';sum.innerHTML='';return;}

    const total=withdrawals.reduce((s,t)=>s+(t.amount||0),0);
    sum.innerHTML=`<div class="summary-box"><div class="summary-label">총 출금</div><div class="summary-val" style="color:#ef5350">-${fmt(total)}</div></div>`;

    const cats={};
    withdrawals.forEach(t=>{
        const name=t.counterparty||'미분류';
        if(!cats[name])cats[name]={amount:0,count:0};
        cats[name].amount+=t.amount||0;
        cats[name].count++;
    });

    const sorted=Object.entries(cats).sort((a,b)=>b[1].amount-a[1].amount);
    let html='';
    sorted.forEach(([name,data])=>{
        html+=`<div class="cat-item"><div><div class="cat-name">${name}</div><div class="cat-count">${data.count}건</div></div><div class="cat-amount">-${fmt(data.amount)}</div></div>`;
    });
    el.innerHTML=html;
}

// --- 로그 렌더링 ---
function setLogFilter(tag){
    logFilterTag=tag;
    document.querySelectorAll('#logFilter .filter-btn').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    renderLogs();
}

function renderLogs(){
    const el=document.getElementById('logContent');
    if(!logs.length){el.innerHTML='<div class="empty">로그 없음</div>';return;}

    let filtered=logs;
    if(logFilterTag!=='all')filtered=logs.filter(l=>(l.tag||'')===logFilterTag);

    const html=filtered.slice(0,200).map(l=>{
        const tagCls=(l.tag||'').replace(/[\[\]]/g,'').toLowerCase();
        return`<div class="log-item"><span class="log-ts">${tsFmt(l.ts)}</span><span class="log-tag ${tagCls}">${l.tag||''}</span><span class="log-msg">${l.msg||''}</span></div>`;
    }).join('');
    el.innerHTML=html||'<div class="empty">필터 결과 없음</div>';
}

// --- 권한 렌더링 ---
function renderPermissions(){
    const el=document.getElementById('permContent');
    if(typeof NativeBridge!=='undefined'){
        try{
            const json=NativeBridge.getPermissions();
            const p=JSON.parse(json);
            const ver=NativeBridge.getAppVersion();
            el.innerHTML=`
                <div class="perm-item"><span class="perm-name">알림 접근 권한</span><span class="perm-status ${p.notification?'on':'off'}" onclick="${!p.notification?'NativeBridge.openNotificationSettings()':''}">${p.notification?'활성':'비활성'}</span></div>
                <div class="perm-item"><span class="perm-name">접근성 권한 (BBQ)</span><span class="perm-status ${p.accessibility?'on':'off'}" onclick="${!p.accessibility?'NativeBridge.openAccessibilitySettings()':''}">${p.accessibility?'활성':'비활성'}</span></div>
                <div class="perm-item"><span class="perm-name">앱 버전</span><span style="color:#888">${ver}</span></div>
            `;
            document.getElementById('versionInfo').textContent=`BankTotal v${ver}`;
        }catch(e){
            el.innerHTML='<div class="empty">권한 정보 로드 실패</div>';
        }
    }else{
        el.innerHTML=`
            <div class="perm-item"><span class="perm-name">알림 접근 권한</span><span class="perm-status off">웹 모드</span></div>
            <div class="perm-item"><span class="perm-name">접근성 권한 (BBQ)</span><span class="perm-status off">웹 모드</span></div>
            <div class="perm-item"><span class="perm-name">모드</span><span style="color:#4fc3f7">웹 브라우저</span></div>
        `;
    }
}

// --- 정산 렌더링 ---
// 정산 시뮬레이션 — 개별 항목 상태 (_key → {ex, sh})
let itemState={};
function ist(k){if(!itemState[k])itemState[k]={ex:false,sh:0};return itemState[k]}
function toggleItem(k){ist(k).ex=!ist(k).ex;renderSettle()}

// 스와이프 드래그 — 좌우=날짜이동, 탭=포함/제외
let swSt=null;
function swStart(e,key){swSt={key,sx:e.touches[0].clientX,sy:e.touches[0].clientY,el:e.currentTarget,sw:false,t0:Date.now(),moved:false}}
document.addEventListener('touchmove',function(e){
    if(!swSt)return;
    const dx=e.touches[0].clientX-swSt.sx;
    const dy=e.touches[0].clientY-swSt.sy;
    swSt.dx=dx;swSt.dy=dy;
    if(Math.abs(dx)>8||Math.abs(dy)>8)swSt.moved=true;
    if(!swSt.sw&&Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>20){swSt.sw=true}
    if(swSt.sw){
        e.preventDefault();
        swSt.el.style.transform=`translateX(${dx}px)`;
        swSt.el.style.opacity=Math.max(0.3,1-Math.abs(dx)/200);
    }
},{passive:false});
document.addEventListener('touchend',function(e){
    if(!swSt)return;
    swSt.el.style.transform='';swSt.el.style.opacity='';swSt.el.style.transition='transform .2s,opacity .2s';
    setTimeout(()=>{if(swSt&&swSt.el)swSt.el.style.transition=''},200);
    const dt=Date.now()-swSt.t0;
    if(swSt.sw){
        const dx=swSt.dx||0;
        const days=Math.round(dx/60);
        if(days!==0){ist(swSt.key).sh+=days;renderSettle()}
    }else if(!swSt.moved&&dt<300){
        toggleItem(swSt.key);
    }
    swSt=null;
})

function renderSettle(){
    const sum=document.getElementById('settleSummary');
    const el=document.getElementById('settleContent');
    const currentBalance=Object.values(accounts).reduce((s,a)=>s+(a.balance||0),0);
    const now=new Date();now.setHours(0,0,0,0);
    const dayNames=['일','월','화','수','목','금','토'];

    const items=generateAllItems(settleManual,settleAuto,30);
    const included=items.filter(u=>!u.excluded);
    const expectedIn=included.filter(u=>u.type==='입금').reduce((s,u)=>s+u.amount,0);
    const expectedOut=included.filter(u=>u.type==='출금').reduce((s,u)=>s+u.amount,0);
    const predicted=currentBalance+expectedIn-expectedOut;
    const exCnt=items.filter(u=>u.excluded).length;

    sum.innerHTML=`<div class="summary-row">
        <div class="summary-box"><div class="summary-label">현재</div><div class="summary-val" style="font-size:18px">${fmt(currentBalance)}</div></div>
        <div class="summary-box"><div class="summary-label">예상 30일</div><div class="summary-val" style="font-size:16px;color:${predicted>=0?'#4fc3f7':'#ef5350'}">${fmt(predicted)}</div></div>
    </div>${exCnt?`<div style="text-align:center;font-size:11px;color:#ff9800;margin-top:4px">${exCnt}건 제외중</div>`:''}`;

    const upByDate={};
    items.forEach(u=>{const d=dateFmt(u.date);if(!upByDate[d])upByDate[d]=[];upByDate[d].push(u)});

    let html=`<div style="display:flex;align-items:center;padding:4px;border-bottom:1px solid #333">
        <span style="min-width:55px;font-size:10px;color:#666">시점</span>
        <span style="flex:1;font-size:10px;color:#666">내역 <span style="color:#444">탭=제외 · 좌우드래그=이동</span></span>
        <span style="min-width:60px;text-align:right;font-size:10px;color:#666">금액</span>
        <span style="min-width:70px;text-align:right;font-size:10px;color:#666">예상잔고</span>
    </div>`;

    html+=`<div style="display:flex;align-items:center;padding:6px 4px;border-bottom:1px solid #1a1a1a;background:#4fc3f711">
        <span style="min-width:55px;font-size:12px;color:#4fc3f7">현재</span>
        <span style="flex:1;font-size:12px;color:#aaa">잔고</span>
        <span style="min-width:60px"></span>
        <span style="min-width:70px;text-align:right;font-size:14px;font-weight:bold;color:#4fc3f7">${fmt(currentBalance)}</span>
    </div>`;

    let bal=currentBalance;
    for(let i=0;i<30;i++){
        const d=new Date(now.getTime()+i*86400000);
        const dk=dateFmt(d.getTime());
        const dayName=dayNames[d.getDay()];
        const dayItems=upByDate[dk]||[];
        const isToday=i===0;
        const dayColor=d.getDay()===0?'#ef5350':d.getDay()===6?'#4fc3f7':'#888';
        if(dayItems.length){
            dayItems.forEach((u,j)=>{
                const isIn=u.type==='입금';
                const delta=isIn?u.amount:-u.amount;
                if(!u.excluded)bal+=delta;
                const op=u.excluded?'opacity:.35;':'';
                const bg=u.excluded?'':u.isPending?'background:#ff980011;':isToday?'background:#4fc3f711;':'';
                const amtC=isIn?'#4caf50':'#ef5350';
                const nmC=u.isPending?'#ff9800':u.overdue?'#ff9800':'#aaa';
                const dl=j===0?`${dk}(${dayName})`:'';
                const tag=u.isPending?' ⚡':'';
                const stk=u.excluded?'text-decoration:line-through;':'';
                html+=`<div style="display:flex;align-items:center;padding:6px 4px;border-bottom:1px solid #1a1a1a;${bg}${op}">
                    <span style="min-width:55px;font-size:11px;color:${dayColor}">${dl}</span>
                    <span ontouchstart="swStart(event,'${u._key}')" style="flex:1;font-size:12px;color:${nmC};cursor:pointer;touch-action:pan-y">${u.name}${u.overdue?' (지연)':''}${tag}</span>
                    <span style="min-width:60px;text-align:right;font-size:12px;color:${amtC};${stk}">${isIn?'+':'-'}${fmt(u.amount)}</span>
                    <span style="min-width:70px;text-align:right;font-size:13px;font-weight:bold;color:${bal>=0?'#e0e0e0':'#ef5350'}">${fmt(bal)}</span>
                </div>`;
            });
        }else{
            const bg=isToday?'background:#4fc3f711;':'';
            html+=`<div style="display:flex;align-items:center;padding:6px 4px;border-bottom:1px solid #1a1a1a;${bg}">
                <span style="min-width:55px;font-size:11px;color:${dayColor}">${dk}(${dayName})</span>
                <span style="flex:1"></span>
                <span style="min-width:60px"></span>
                <span style="min-width:70px;text-align:right;font-size:13px;color:#555">${fmt(bal)}</span>
            </div>`;
        }
    }
    el.innerHTML=html;
}

function generateAllItems(manual,auto,days){
    const result=[];
    const now=new Date();now.setHours(0,0,0,0);
    const end=new Date(now.getTime()+days*86400000);
    manual.forEach(m=>{
        if(m.cycle==='none'){
            const key=m._id;
            const st=ist(key);
            const day=Math.max(0,Math.min(29,st.sh));
            const d=new Date(now.getTime()+day*86400000);
            result.push({name:m.name,amount:m.amount||0,type:m.type||'출금',date:d.getTime(),_key:key,_id:m._id,isPending:true,excluded:st.ex});
            return;
        }
        for(let i=0;i<days;i++){
            const d=new Date(now.getTime()+i*86400000);
            let match=false;
            if(m.cycle==='daily')match=true;
            if(m.cycle==='monthly'&&d.getDate()===(m.dayOfMonth||1))match=true;
            if(m.cycle==='weekly'&&d.getDay()===(m.dayOfWeek||0))match=true;
            if(match){
                const key=m._id+'_'+i;
                const st=ist(key);
                const newDay=Math.max(0,Math.min(29,i+st.sh));
                const nd=new Date(now.getTime()+newDay*86400000);
                result.push({name:m.name,amount:m.amount||0,type:m.type||'출금',date:nd.getTime(),_key:key,_id:m._id,excluded:st.ex});
            }
        }
    });
    auto.forEach(a=>{
        if(a.cycle==='none'){
            const key=a._id;
            const st=ist(key);
            const day=Math.max(0,Math.min(29,st.sh));
            const d=new Date(now.getTime()+day*86400000);
            result.push({name:a.name||a.source||'밀림',amount:a.amount||0,type:a.type||'출금',date:d.getTime(),_key:key,_id:a._id,isPending:true,excluded:st.ex});
            return;
        }
        if(!a.dueDate&&!a.amount)return;
        const due=a.dueDate||now.getTime();
        const tp=a.type||'출금';
        const showDate=(tp==='출금'&&due<now.getTime())?now.getTime():due;
        if(showDate<=end.getTime()){
            const origDay=Math.round((showDate-now.getTime())/86400000);
            const key=a._id;
            const st=ist(key);
            const newDay=Math.max(0,Math.min(29,origDay+st.sh));
            const nd=new Date(now.getTime()+newDay*86400000);
            result.push({name:a.name||a.source||'고지서',amount:a.amount||0,type:tp,date:nd.getTime(),_key:key,_id:a._id,overdue:a.dueDate&&a.dueDate<now.getTime(),excluded:st.ex});
        }
    });
    return result.sort((a,b)=>a.date-b.date);
}

function deleteSettle(id){
    if(!confirm('삭제하시겠습니까?'))return;
    fetch(FB+'/banktotal/settle/manual/'+id+'.json',{method:'DELETE'}).catch(()=>alert('삭제 실패'));
}

function deleteAutoSettle(id){
    if(!confirm('삭제하시겠습니까?'))return;
    fetch(FB+'/banktotal/settle/auto/'+id+'.json',{method:'DELETE'}).catch(()=>alert('삭제 실패'));
}

// --- AI 재무상담 (Gemini API) ---
let aiMessages=[];

function promptAiKey(){
    const cur=loadAiKey();
    const val=prompt('Gemini API Key'+(cur?' (현재 설정됨)':''),cur||'');
    if(val!==null&&val.trim()){
        localStorage.setItem('gemini_api_key',val.trim());
        if(typeof NativeBridge!=='undefined')try{NativeBridge.setGeminiKey(val.trim())}catch(e){}
        document.getElementById('aiKeyBtn').style.color='#4caf50';
    }
}

function loadAiKey(){
    // 네이티브 키 우선 → localStorage → Firebase 순
    let k=localStorage.getItem('gemini_api_key')||'';
    if(typeof NativeBridge!=='undefined'){
        try{
            const nk=NativeBridge.getGeminiKey();
            if(nk){k=nk;localStorage.setItem('gemini_api_key',k)}
            else if(k){NativeBridge.setGeminiKey(k)}
        }catch(e){}
    }
    if(!k){
        // Firebase에서 로드 (비동기, 다음 호출부터 사용)
        fetch(FB+'/banktotal/settings/gemini_key.json').then(r=>r.json()).then(d=>{
            if(d&&typeof d==='string'){
                localStorage.setItem('gemini_api_key',d);
                if(typeof NativeBridge!=='undefined')try{NativeBridge.setGeminiKey(d)}catch(e){}
                const st=document.getElementById('aiKeyStatus');
                if(st){st.textContent='설정됨';st.style.color='#4caf50'}
            }
        }).catch(()=>{});
    }
    return k;
}

function buildFinCtx(){
    const accs=Object.values(accounts);
    const totalBal=accs.reduce((s,a)=>s+(a.balance||0),0);
    let c='';
    if(aiRules.business){
        c+=`[사업 정보] ${aiRules.business}\n`;
        if(aiRules.income)c+='수입원: '+aiRules.income.join(', ')+'\n';
        if(aiRules.expenses)c+='지출: '+aiRules.expenses.join(', ')+'\n';
        if(aiRules.rules)c+='규칙: '+aiRules.rules.join(' / ')+'\n\n';
    }
    c+=`[현재 재무]\n총 잔고: ${totalBal.toLocaleString()}원\n`;
    accs.forEach(a=>{c+=`- ${a.bank||''} ${a.account||''}: ${(a.balance||0).toLocaleString()}원\n`});

    const now=Date.now();
    const recent=transactions.filter(t=>t.ts&&now-t.ts<30*86400000&&!t._excluded);
    const tIn=recent.filter(t=>t.type==='입금').reduce((s,t)=>s+(t.amount||0),0);
    const tOut=recent.filter(t=>t.type==='출금').reduce((s,t)=>s+(t.amount||0),0);
    c+=`\n[최근 30일] 입금: ${tIn.toLocaleString()}원, 출금: ${tOut.toLocaleString()}원\n`;

    const cats={};
    recent.filter(t=>t.type==='출금').forEach(t=>{const n=t.counterparty||'미분류';cats[n]=(cats[n]||0)+(t.amount||0)});
    if(Object.keys(cats).length){
        c+='출금 카테고리:\n';
        Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(([n,a])=>{c+=`- ${n}: ${a.toLocaleString()}원\n`});
    }

    c+='\n최근 거래:\n';
    recent.slice(0,20).forEach(t=>{
        const d=new Date(t.ts);
        c+=`- ${d.getMonth()+1}/${d.getDate()} ${t.type} ${(t.amount||0).toLocaleString()}원 ${t.counterparty||t.bank||''}\n`;
    });

    if(settleManual.length){
        c+='\n[정기 항목]\n';
        settleManual.forEach(m=>{
            const cycleLabel=m.cycle==='none'?'밀린금액':m.cycle==='daily'?'매일':m.cycle==='weekly'?'매주':'매월';
            c+=`- ${m.name}: ${m.type} ${(m.amount||0).toLocaleString()}원 (${cycleLabel})\n`;
        });
    }
    if(settleAuto.length){
        c+='\n[예정 고지서]\n';
        settleAuto.forEach(a=>{c+=`- ${a.name||'고지서'}: ${(a.amount||0).toLocaleString()}원\n`});
    }
    return c;
}

async function askAi(q){
    if(!q){q=(document.getElementById('aiInput').value||'').trim();if(!q)return}
    const key=loadAiKey();
    if(!key){alert('Gemini API Key를 입력하세요');return}

    document.getElementById('aiInput').value='';
    aiMessages.push({role:'user',text:q});
    aiMessages.push({role:'bot',text:'분석 중...'});
    renderAiMsgs();

    const btn=document.getElementById('aiSendBtn');
    btn.disabled=true;btn.textContent='...';

    const ctx=buildFinCtx();
    const sys=`당신은 개인 재무 상담사입니다. 사용자의 실제 계좌와 거래 내역을 기반으로 예산 설계, 지출 분석, 절약 팁, 잔고 예측 등을 제공합니다.

${ctx}

위 데이터를 기반으로 구체적 숫자를 활용해 분석하세요. 한국어로 간결하게 답변하세요.

[중요] 사용자가 정기 항목이나 규칙 등록/삭제를 요청하면, 답변 맨 끝에 액션 태그를 추가하세요:

정기항목 등록: [ACTION]{"act":"add","name":"항목명","amount":금액숫자,"txType":"입금또는출금","cycle":"daily또는weekly또는monthly또는none","day":숫자}[/ACTION]
- cycle: daily=매일, weekly=매주(day:0일~6토), monthly=매월(day:1~31), none=날짜미정(밀린금액/미정채무)
- 130만원→1300000, 50만원→500000 등 반드시 숫자로 변환
- 밀린금액이나 날짜가 미정인 채무는 cycle:"none"으로 등록
정기항목 삭제: [ACTION]{"act":"del","name":"항목명"}[/ACTION]
규칙 추가: [ACTION]{"act":"add_rule","rule":"새 규칙 내용"}[/ACTION]
규칙 삭제: [ACTION]{"act":"del_rule","rule":"삭제할 규칙 내용"}[/ACTION]
사업정보 수정: [ACTION]{"act":"set_info","key":"income또는expenses또는accounts또는business","value":"값"}[/ACTION]

액션 태그 앞에 확인 메시지를 먼저 쓰세요. 여러 액션은 각각 별도 [ACTION]...[/ACTION]으로.`;

    try{
        const ctrl=new AbortController();
        const tmr=setTimeout(()=>ctrl.abort(),30000);
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+key,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[{text:sys+'\n\n사용자: '+q}]}]}),
            signal:ctrl.signal
        });
        clearTimeout(tmr);
        if(!r.ok){
            const err=await r.text();
            aiMessages[aiMessages.length-1].text='API 에러 '+r.status+': '+(err.substring(0,200));
        }else{
            const d=await r.json();
            let reply=d?.candidates?.[0]?.content?.parts?.[0]?.text||d?.error?.message||'응답 없음';
            const actionMatches=[...reply.matchAll(/\[ACTION\](.*?)\[\/ACTION\]/g)];
            for(const m of actionMatches){
                try{await executeAiAction(JSON.parse(m[1]))}catch(e){}
            }
            if(actionMatches.length)reply=reply.replace(/\[ACTION\].*?\[\/ACTION\]/g,'').trim();
            aiMessages[aiMessages.length-1].text=reply;
        }
    }catch(e){
        aiMessages[aiMessages.length-1].text='오류: '+(e.name==='AbortError'?'30초 타임아웃':e.message);
    }
    btn.disabled=false;btn.textContent='전송';
    renderAiMsgs();
}

function loadLatestImage(){
    if(typeof NativeBridge!=='undefined'){
        try{
            const b64=NativeBridge.getLatestImage();
            if(b64&&b64.length>100){analyzeBase64(b64,'image/jpeg');return}
        }catch(e){}
    }
    document.getElementById('aiFileInput').click();
}

async function analyzeBase64(base64,mime){
    const key=loadAiKey();
    if(!key){alert('Gemini API Key를 먼저 설정하세요');return}

    aiMessages.push({role:'user',text:'[최근 사진 분석]'});
    aiMessages.push({role:'bot',text:'이미지 분석 중...'});
    renderAiMsgs();

    const btn=document.getElementById('aiSendBtn');
    btn.disabled=true;btn.textContent='...';

    const ctx=buildFinCtx();
    const prompt=`당신은 개인 재무 상담사입니다. 이 이미지를 분석하세요.

고지서/청구서/영수증/은행명세서/카드내역 등 금융 문서라면:
- 항목명, 금액, 납기일, 입금/출금 여부를 추출하세요
- 정기 항목이면 등록 액션을 추가하세요
금융 문서가 아니면 이미지 내용을 간단히 설명하세요.

${ctx}

[액션 형식]
등록: [ACTION]{"act":"add","name":"항목명","amount":금액,"txType":"입금또는출금","cycle":"daily또는weekly또는monthly또는none","day":숫자}[/ACTION]`;

    try{
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+key,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[
                {text:prompt},
                {inline_data:{mime_type:mime,data:base64}}
            ]}]})
        });
        const d=await r.json();
        let reply=d?.candidates?.[0]?.content?.parts?.[0]?.text||d?.error?.message||'분석 실패';
        const actionMatches=[...reply.matchAll(/\[ACTION\](.*?)\[\/ACTION\]/g)];
        for(const m of actionMatches){try{await executeAiAction(JSON.parse(m[1]))}catch(e){}}
        if(actionMatches.length)reply=reply.replace(/\[ACTION\].*?\[\/ACTION\]/g,'').trim();
        aiMessages[aiMessages.length-1].text=reply;
    }catch(e){
        aiMessages[aiMessages.length-1].text='오류: '+e.message;
    }
    btn.disabled=false;btn.textContent='AI';
    renderAiMsgs();
}

async function analyzeImage(input){
    const file=input.files[0];if(!file)return;
    const key=loadAiKey();
    if(!key){alert('Gemini API Key를 먼저 설정하세요');return}

    const reader=new FileReader();
    reader.onload=async function(){
        const base64=reader.result.split(',')[1];
        const mime=file.type||'image/jpeg';

        aiMessages.push({role:'user',text:'[이미지 분석 요청]'});
        aiMessages.push({role:'bot',text:'이미지 분석 중...'});
        renderAiMsgs();

        const btn=document.getElementById('aiSendBtn');
        btn.disabled=true;btn.textContent='...';

        const ctx=buildFinCtx();
        const prompt=`당신은 개인 재무 상담사입니다. 이 이미지를 분석하세요.

고지서/청구서/영수증/은행명세서/카드내역 등 금융 문서라면:
- 항목명, 금액, 납기일, 입금/출금 여부를 추출하세요
- 정기 항목이면 등록 액션을 추가하세요

${ctx}

[액션 형식]
등록: [ACTION]{"act":"add","name":"항목명","amount":금액,"txType":"입금또는출금","cycle":"daily또는weekly또는monthly또는none","day":숫자}[/ACTION]

분석 결과를 간결하게 요약하고, 등록 가능한 항목이 있으면 액션 태그를 추가하세요.`;

        try{
            const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+key,{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[
                    {text:prompt},
                    {inline_data:{mime_type:mime,data:base64}}
                ]}]})
            });
            const d=await r.json();
            let reply=d?.candidates?.[0]?.content?.parts?.[0]?.text||d?.error?.message||'분석 실패';
            const actionMatches=[...reply.matchAll(/\[ACTION\](.*?)\[\/ACTION\]/g)];
            for(const m of actionMatches){
                try{await executeAiAction(JSON.parse(m[1]))}catch(e){}
            }
            if(actionMatches.length)reply=reply.replace(/\[ACTION\].*?\[\/ACTION\]/g,'').trim();
            aiMessages[aiMessages.length-1].text=reply;
        }catch(e){
            aiMessages[aiMessages.length-1].text='오류: '+e.message;
        }
        btn.disabled=false;btn.textContent='AI';
        renderAiMsgs();
        input.value='';
    };
    reader.readAsDataURL(file);
}

async function executeAiAction(act){
    if(act.act==='add'){
        const entry={name:act.name||'항목',amount:act.amount||0,type:act.txType||'입금',cycle:act.cycle||'daily',ts:Date.now()};
        if(act.cycle==='weekly')entry.dayOfWeek=act.day||0;
        else if(act.cycle==='monthly')entry.dayOfMonth=act.day||1;
        // cycle:"none" → 날짜 미지정 밀린금액 (dayOfWeek/dayOfMonth 불필요)
        const id='sm_'+Date.now();
        await fetch(FB+'/banktotal/settle/manual/'+id+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(entry)});
    }else if(act.act==='del'){
        const target=settleManual.find(m=>m.name===act.name);
        if(target)await fetch(FB+'/banktotal/settle/manual/'+target._id+'.json',{method:'DELETE'});
    }else if(act.act==='add_rule'){
        const rules=aiRules.rules||[];
        rules.push(act.rule);
        await fetch(FB+'/banktotal/ai_rules/rules.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(rules)});
        aiRules.rules=rules;
    }else if(act.act==='del_rule'){
        const rules=(aiRules.rules||[]).filter(r=>r!==act.rule);
        await fetch(FB+'/banktotal/ai_rules/rules.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(rules)});
        aiRules.rules=rules;
    }else if(act.act==='set_info'){
        const val=act.value;
        await fetch(FB+'/banktotal/ai_rules/'+act.key+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(val)});
        aiRules[act.key]=val;
    }
}

function renderAiMsgs(){
    const el=document.getElementById('aiMsgs');if(!el)return;
    el.innerHTML=aiMessages.map(m=>`<div class="ai-msg ${m.role}">${m.text.replace(/\n/g,'<br>')}</div>`).join('');
    el.scrollTop=el.scrollHeight;
}

// --- 새로고침 ---
function doRefresh(){
    const btn=document.getElementById('refreshBtn');
    btn.classList.add('spinning');
    setTimeout(()=>btn.classList.remove('spinning'),600);
    // 웹페이지 자체를 최신 버전으로 리로드
    location.reload(true);
}

// --- 초기화 ---
window.onload=function(){
    if(typeof NativeBridge!=='undefined'){
        loadFromNative();
        // 네이티브에서도 Firebase SSE로 거래/로그 데이터 로드
        initSSE();
    }else{
        initSSE();
    }
    renderPermissions();
    loadAiKey();

    // 앱에서 호출할 수 있는 리프레시 함수
    window.refreshFromNative=function(){loadFromNative();};
};
</script>
</body>
</html>
