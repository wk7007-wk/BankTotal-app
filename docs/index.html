<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>BankTotal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#121212;color:#e0e0e0;min-height:100vh;overflow-x:hidden}
.header{background:#1a1a2e;padding:20px 16px;text-align:center;position:sticky;top:0;z-index:10;position:relative}
.refresh-btn{position:absolute;top:16px;right:12px;background:#333;border:none;color:#4fc3f7;font-size:20px;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
.refresh-btn:active{background:#444}
.refresh-btn.spinning{animation:spin .6s linear}
.subtotal-row{color:#fff;font-size:14px;margin-bottom:2px;display:none}
.subtotal-row.show{display:block}
.subtotal-val{font-size:32px;font-weight:bold;color:#fff}
.total-label{color:#666;font-size:12px;margin-top:4px}
.total-val{font-size:16px;color:#888;margin:2px 0}
.last-update{color:#666;font-size:12px}
.tabs{display:flex;background:#1e1e30;overflow-x:auto;position:sticky;top:0;z-index:9}
.tab{flex:1;min-width:60px;padding:10px 8px;text-align:center;font-size:13px;color:#888;border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap}
.tab.active{color:#4fc3f7;border-bottom-color:#4fc3f7}
.section{display:none;padding:12px}
.section.active{display:block}
.card{background:#1e1e30;border-radius:10px;padding:12px;margin-bottom:8px}
.card-row{display:flex;justify-content:space-between;align-items:center}
.bank-name{font-size:13px;color:#888;min-width:40px}
.alias{font-size:15px;color:#e0e0e0}
.balance{font-size:18px;font-weight:bold;color:#4fc3f7;text-align:right}
.balance.negative{color:#ef5350}
.inactive .balance{opacity:.5}
.inactive .alias{opacity:.5}
.last-tx{font-size:11px;color:#666;margin-top:4px}
.active-badge{font-size:10px;padding:2px 6px;border-radius:8px;background:#4caf5033;color:#4caf50}
.inactive .active-badge{background:#99999933;color:#999}
.filter-row{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.filter-btn{padding:6px 12px;border-radius:16px;border:1px solid #333;background:transparent;color:#aaa;font-size:12px;cursor:pointer}
.filter-btn.active{background:#4fc3f7;color:#121212;border-color:#4fc3f7}
.tx-group{margin-bottom:12px}
.tx-date{font-size:12px;color:#666;padding:4px 0;border-bottom:1px solid #222}
.tx-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #1a1a1a}
.tx-left{display:flex;flex-direction:column;gap:2px}
.tx-bank{font-size:11px;color:#888}
.tx-cp{font-size:13px;color:#ccc}
.tx-time{font-size:10px;color:#555}
.tx-amount{font-size:15px;font-weight:bold;text-align:right}
.tx-amount.in{color:#4caf50}
.tx-amount.out{color:#ef5350}
.tx-balance{font-size:10px;color:#666;text-align:right}
.tx-item.excluded{opacity:.35}
.tx-item.excluded .tx-amount{text-decoration:line-through}
.tx-excluded-tag{font-size:9px;color:#666;background:#333;padding:1px 5px;border-radius:4px;margin-left:4px}
.cat-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #1a1a1a}
.cat-name{font-size:14px;color:#ccc}
.cat-count{font-size:11px;color:#666}
.cat-amount{font-size:16px;font-weight:bold;color:#ef5350}
.log-item{padding:6px 0;border-bottom:1px solid #1a1a1a;font-family:monospace;font-size:12px}
.log-ts{color:#555}
.log-tag{font-weight:bold;margin:0 4px}
.log-tag.tx{color:#4caf50}
.log-tag.parse{color:#4fc3f7}
.log-tag.err{color:#ef5350}
.log-tag.sys{color:#ff9800}
.log-msg{color:#ccc}
.perm-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#1e1e30;border-radius:10px;margin-bottom:8px}
.perm-name{font-size:14px;color:#ccc}
.perm-status{font-size:13px;font-weight:bold;padding:4px 10px;border-radius:12px}
.perm-status.on{background:#4caf5033;color:#4caf50}
.perm-status.off{background:#ef535033;color:#ef5350;cursor:pointer}
.summary-box{background:#1e1e30;border-radius:10px;padding:16px;margin-bottom:12px;text-align:center}
.summary-label{font-size:12px;color:#888}
.summary-val{font-size:24px;font-weight:bold;color:#4fc3f7;margin-top:4px}
.summary-row{display:flex;gap:8px}
.summary-row .summary-box{flex:1}
.empty{text-align:center;color:#555;padding:40px 0;font-size:14px}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.version{text-align:center;color:#444;font-size:11px;padding:20px 0}
.settle-tag{font-size:10px;padding:1px 5px;border-radius:4px;margin-left:4px}
.settle-tag.manual{color:#4fc3f7;background:#4fc3f722}
.settle-tag.auto{color:#ff9800;background:#ff980022}
.predicted-bal{font-size:11px;color:#888;float:right}
.ai-msgs{max-height:300px;overflow-y:auto;margin:8px 0}
.ai-msg{padding:8px 12px;border-radius:10px;margin-bottom:6px;font-size:13px;line-height:1.6;white-space:pre-wrap}
.ai-msg.user{background:#4fc3f722;color:#4fc3f7;text-align:right}
.ai-msg.bot{background:#2a2a40;color:#e0e0e0}
.ai-input-row{display:flex;gap:6px}
.ai-input{flex:1;padding:10px;background:#2a2a40;border:1px solid #333;border-radius:8px;color:#e0e0e0;font-size:14px;outline:none}
.ai-send{padding:10px 16px;background:#4fc3f7;color:#121212;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer}
.ai-send:disabled{opacity:.4}
</style>
</head>
<body>

<div class="header" id="header">
    <button class="refresh-btn" id="refreshBtn" onclick="doRefresh()">&#x21bb;</button>
    <div class="subtotal-row" id="subtotalRow">
        <div style="color:#888;font-size:12px">소계</div>
        <span class="subtotal-val" id="subtotalVal">0</span>
    </div>
    <div class="total-label">합산</div>
    <div class="total-val" id="totalVal">0</div>
    <div class="last-update" id="lastUpdate">마지막 업데이트: --</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="showTab('settle')">정산</div>
    <div class="tab" onclick="showTab('accounts')">계좌</div>
    <div class="tab" onclick="showTab('ledger')">가계부</div>
</div>

<div class="section" id="sec-accounts">
    <div id="accountList"></div>
</div>

<div class="section" id="sec-ledger">
    <div class="filter-row" id="ledgerFilter">
        <div class="filter-btn active" onclick="setLedgerFilter('out')">출금</div>
        <div class="filter-btn" onclick="setLedgerFilter('in')">입금</div>
        <div class="filter-btn" onclick="setLedgerFilter('all')">전체</div>
        <div class="filter-btn" onclick="setLedgerFilter('cat')">카테고리</div>
    </div>
    <div id="ledgerSummary"></div>
    <div id="ledgerContent"></div>
</div>

<div class="section active" id="sec-settle">
    <div id="settleSummary"></div>
    <div id="settleContent"></div>
    <div style="margin-top:12px">
        <div class="ai-msgs" id="aiMsgs"></div>
        <div class="ai-input-row">
            <input type="file" id="aiFileInput" accept="image/*" style="display:none" onchange="analyzeImage(this)">
            <button onclick="loadLatestImage()" style="padding:8px 10px;background:#2a2a40;border:1px solid #333;border-radius:8px;color:#aaa;font-size:16px;cursor:pointer">&#128247;</button>
            <input class="ai-input" id="aiInput" placeholder="항목등록, 재무질문, 사진분석..." onkeydown="if(event.key==='Enter')askAi()" style="font-size:13px;padding:8px">
            <button class="ai-send" id="aiSendBtn" onclick="askAi()" style="padding:8px 12px;font-size:13px">AI</button>
        </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:6px">
        <div class="card" onclick="showTab('logs')" style="cursor:pointer;text-align:center;font-size:11px;color:#4fc3f7;flex:1;padding:8px">로그</div>
        <div class="card" onclick="showTab('perms')" style="cursor:pointer;text-align:center;font-size:11px;color:#4fc3f7;flex:1;padding:8px">권한</div>
        <div class="card" onclick="promptAiKey()" style="cursor:pointer;text-align:center;font-size:11px;color:#888;flex:1;padding:8px" id="aiKeyBtn">API키</div>
    </div>
</div>

<div class="section" id="sec-logs">
    <div class="filter-row" id="logFilter">
        <div class="filter-btn active" onclick="setLogFilter('all')">전체</div>
        <div class="filter-btn" onclick="setLogFilter('[TX]')">TX</div>
        <div class="filter-btn" onclick="setLogFilter('[PARSE]')">PARSE</div>
        <div class="filter-btn" onclick="setLogFilter('[ERR]')">ERR</div>
        <div class="filter-btn" onclick="setLogFilter('[SYS]')">SYS</div>
    </div>
    <div id="logContent"></div>
</div>

<div class="section" id="sec-perms">
    <div id="permContent"></div>
</div>

<div class="version" id="versionInfo">BankTotal Web Dashboard</div>

<script>
const FB='https://poskds-4ba60-default-rtdb.asia-southeast1.firebasedatabase.app';
const fmt=n=>{if(n==null)return'0';const s=n<0;const a=Math.abs(n);return(s?'-':'')+a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')};
const tsFmt=ts=>{const d=new Date(ts);return`${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`};
const dateFmt=ts=>{const d=new Date(ts);return`${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`};
const timeFmt=ts=>{const d=new Date(ts);return`${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`};

let accounts={},transactions=[],logs=[],settleManual=[],settleAuto=[],aiRules={},sfaDaily={},currentTab='settle',ledgerMode='out',logFilterTag='all';

// --- 거래 마킹: 이체/중복은 _excluded + _reason 표시, 합산 제외 ---
function markTransactions(txList){
    const sorted=[...txList].sort((a,b)=>(a.ts||0)-(b.ts||0));
    // 1) 동일계좌 이체 (동일금액+5분내+다른은행+입출금반대)
    for(let i=0;i<sorted.length;i++){
        for(let j=i+1;j<sorted.length;j++){
            const a=sorted[i],b=sorted[j];
            if(Math.abs((a.ts||0)-(b.ts||0))>300000)break;
            if(a.amount===b.amount&&a.type!==b.type&&a.bank!==b.bank&&!a._excluded&&!b._excluded){
                a._excluded=true;a._reason='이체';
                b._excluded=true;b._reason='이체';
                break;
            }
        }
    }
    // 2) 중복 (같은 은행+금액+타입, 60초 이내)
    for(let i=0;i<sorted.length;i++){
        if(sorted[i]._excluded)continue;
        for(let j=i+1;j<sorted.length;j++){
            const a=sorted[i],b=sorted[j];
            if(Math.abs((a.ts||0)-(b.ts||0))>60000)break;
            if(a.bank===b.bank&&a.amount===b.amount&&a.type===b.type&&!b._excluded){
                b._excluded=true;b._reason='중복';
            }
        }
    }
    return sorted;
}

// --- 탭 관리 ---
function showTab(name){
    currentTab=name;
    document.querySelectorAll('.tab').forEach((t,i)=>{
        const tabs=['accounts','ledger','settle'];
        t.classList.toggle('active',tabs[i]===name||(name==='logs'&&i===2)||(name==='perms'&&i===2));
    });
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('sec-'+name).classList.add('active');
    if(name==='perms')renderPermissions();
    if(name==='settle')renderSettle();
}

// --- Firebase SSE ---
function connectSSE(path,handler){
    let cache=null;
    const es=new EventSource(FB+path+'.json');
    // Firebase SSE는 named event ('put','patch')로 전송 → addEventListener 사용
    es.addEventListener('put',e=>{
        try{
            const msg=JSON.parse(e.data);
            if(msg.path==='/'){
                cache=msg.data;
                handler(cache);
            }else{
                // 부분 업데이트: 키 머지
                const key=msg.path.replace(/^\//,'');
                if(cache&&key){
                    if(msg.data===null){delete cache[key];}else{cache[key]=msg.data;}
                    handler(cache);
                }else{
                    fetch(FB+path+'.json').then(r=>r.json()).then(d=>{cache=d;handler(d);}).catch(()=>{});
                }
            }
        }catch(ex){}
    });
    es.addEventListener('patch',e=>{
        fetch(FB+path+'.json').then(r=>r.json()).then(d=>{cache=d;handler(d);}).catch(()=>{});
    });
    es.onerror=()=>{setTimeout(()=>connectSSE(path,handler),5000);es.close()};
    // 초기 로드 (SSE put 이벤트 전에 REST로 즉시 로드)
    fetch(FB+path+'.json').then(r=>r.json()).then(d=>{if(d){cache=d;handler(d);}}).catch(()=>{});
}

function initSSE(){
    connectSSE('/banktotal/accounts',d=>{accounts=d||{};renderAccounts();if(currentTab==='settle')renderSettle()});
    connectSSE('/banktotal/transactions',d=>{
        if(!d){transactions=[];renderLedger();return;}
        const prev=transactions.length;
        transactions=markTransactions(Object.values(d)).sort((a,b)=>(b.ts||0)-(a.ts||0));
        renderLedger();
        // 새 출금 거래 발생 시 AI 보정 체크
        if(transactions.length>prev&&prev>0){
            const newTxs=transactions.slice(0,transactions.length-prev);
            const newOut=newTxs.filter(t=>t.type==='출금');
            if(newOut.length)checkSettleCorrection(newOut);
        }
    });
    connectSSE('/banktotal/logs',d=>{
        if(!d){logs=[];renderLogs();return;}
        logs=Object.values(d).sort((a,b)=>(b.ts||0)-(a.ts||0));
        renderLogs();
    });
    connectSSE('/banktotal/settle/manual',d=>{
        settleManual=d?Object.entries(d).map(([k,v])=>({...v,_id:k})):[];
        if(currentTab==='settle')renderSettle();
    });
    connectSSE('/banktotal/settle/auto',d=>{
        settleAuto=d?Object.entries(d).map(([k,v])=>({...v,_id:k})):[];
        if(currentTab==='settle')renderSettle();
    });
    connectSSE('/banktotal/sfa_daily',d=>{
        sfaDaily=d||{};
        if(currentTab==='settle')renderSettle();
    });
    fetch(FB+'/banktotal/ai_rules.json').then(r=>r.json()).then(d=>{if(d)aiRules=d}).catch(()=>{});
}

// --- NativeBridge 지원 (앱 내 WebView) ---
function loadFromNative(){
    if(typeof NativeBridge==='undefined')return false;
    try{
        const json=NativeBridge.getAccountsJson();
        if(json){
            const list=JSON.parse(json);
            renderNativeAccounts(list);
        }
    }catch(e){}
    return true;
}

function renderNativeAccounts(list){
    let total=0,subtotal=0;
    list.forEach(a=>{
        if(a.isActive){total+=a.balance;if(a.balance>=0)subtotal+=a.balance;}
    });
    document.getElementById('totalVal').textContent=fmt(total);
    if(subtotal!==total){
        document.getElementById('subtotalRow').classList.add('show');
        document.getElementById('subtotalVal').textContent=fmt(subtotal);
    }else{
        document.getElementById('subtotalRow').classList.remove('show');
    }
    const lastUp=Math.max(...list.map(a=>a.lastUpdated||0));
    document.getElementById('lastUpdate').textContent=lastUp>0?`마지막 업데이트: ${tsFmt(lastUp)}`:'마지막 업데이트: --';

    const html=list.map(a=>{
        const inactive=!a.isActive?'inactive':'';
        const balCls=a.balance<0?'balance negative':'balance';
        const lastTx=a.lastTransactionType?(
            `${a.lastTransactionType} ${fmt(a.lastTransactionAmount)} · ${tsFmt(a.lastUpdated)}`
        ):(a.lastUpdated>0?tsFmt(a.lastUpdated):'');
        const badge=a.isActive?'합산 포함':'합산 제외';
        const badgeCls=a.isActive?'active-badge':'active-badge';
        return`<div class="card ${inactive}">
            <div class="card-row"><div><span class="bank-name">${a.bankName}</span> <span class="alias">${a.displayName||a.accountNumber}</span></div><div class="${balCls}">${fmt(a.balance)}</div></div>
            <div class="card-row" style="margin-top:4px"><span class="last-tx">${lastTx}</span><span class="${badgeCls}">${badge}</span></div>
        </div>`;
    }).join('');
    document.getElementById('accountList').innerHTML=html||'<div class="empty">계좌 없음</div>';
}

// --- 계좌 렌더링 (Firebase) ---
function renderAccounts(){
    const list=Object.values(accounts);
    if(!list.length){
        document.getElementById('accountList').innerHTML='<div class="empty">계좌 없음</div>';
        document.getElementById('totalVal').textContent='0';
        return;
    }
    let total=0;
    list.forEach(a=>total+=a.balance||0);
    document.getElementById('totalVal').textContent=fmt(total);

    const lastUp=Math.max(...list.map(a=>a.updated||0));
    document.getElementById('lastUpdate').textContent=lastUp>0?`마지막 업데이트: ${tsFmt(lastUp)}`:'마지막 업데이트: --';

    const html=list.sort((a,b)=>(a.bank||'').localeCompare(b.bank||'')).map(a=>{
        const balCls=a.balance<0?'balance negative':'balance';
        return`<div class="card">
            <div class="card-row"><div><span class="bank-name">${a.bank||''}</span> <span class="alias">${a.account||''}</span></div><div class="${balCls}">${fmt(a.balance)}</div></div>
            <div class="card-row" style="margin-top:4px"><span class="last-tx">${a.updated?tsFmt(a.updated):''}</span></div>
        </div>`;
    }).join('');
    document.getElementById('accountList').innerHTML=html;
}

// --- 가계부 렌더링 ---
function setLedgerFilter(mode){
    ledgerMode=mode;
    document.querySelectorAll('#ledgerFilter .filter-btn').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    renderLedger();
}

function renderLedger(){
    const el=document.getElementById('ledgerContent');
    const sum=document.getElementById('ledgerSummary');
    if(!transactions.length){el.innerHTML='<div class="empty">거래 내역 없음</div>';sum.innerHTML='';return;}

    let filtered=transactions;
    if(ledgerMode==='in')filtered=transactions.filter(t=>t.type==='입금');
    if(ledgerMode==='out')filtered=transactions.filter(t=>t.type==='출금');

    if(ledgerMode==='cat'){
        renderCategory(transactions.filter(t=>t.type==='출금'&&!t._excluded));
        return;
    }

    // 요약 (제외 항목 합산 안 함)
    const totalIn=transactions.filter(t=>t.type==='입금'&&!t._excluded).reduce((s,t)=>s+(t.amount||0),0);
    const totalOut=transactions.filter(t=>t.type==='출금'&&!t._excluded).reduce((s,t)=>s+(t.amount||0),0);
    sum.innerHTML=`<div class="summary-row">
        <div class="summary-box"><div class="summary-label">입금</div><div class="summary-val" style="color:#4caf50">+${fmt(totalIn)}</div></div>
        <div class="summary-box"><div class="summary-label">출금</div><div class="summary-val" style="color:#ef5350">-${fmt(totalOut)}</div></div>
    </div>`;

    // 날짜별 그룹
    const grouped={};
    filtered.forEach(t=>{
        const d=dateFmt(t.ts);
        if(!grouped[d])grouped[d]=[];
        grouped[d].push(t);
    });

    let html='';
    for(const[date,txs]of Object.entries(grouped)){
        const dayTotal=txs.filter(t=>!t._excluded).reduce((s,t)=>s+(t.type==='입금'?t.amount:-t.amount),0);
        html+=`<div class="tx-group"><div class="tx-date">${date}  <span style="color:${dayTotal>=0?'#4caf50':'#ef5350'}">${dayTotal>=0?'+':''}${fmt(dayTotal)}</span></div>`;
        txs.forEach(t=>{
            const isIn=t.type==='입금';
            const excCls=t._excluded?'excluded':'';
            const tag=t._reason?`<span class="tx-excluded-tag">${t._reason}</span>`:'';
            html+=`<div class="tx-item ${excCls}">
                <div class="tx-left"><span class="tx-cp">${t.counterparty||t.bank||''}${tag}</span><span class="tx-time">${timeFmt(t.ts)} ${t.bank||''}</span></div>
                <div><div class="tx-amount ${isIn?'in':'out'}">${isIn?'+':'-'}${fmt(t.amount)}</div><div class="tx-balance">잔액 ${fmt(t.balance)}</div></div>
            </div>`;
        });
        html+='</div>';
    }
    el.innerHTML=html;
}

function renderCategory(withdrawals){
    const sum=document.getElementById('ledgerSummary');
    const el=document.getElementById('ledgerContent');
    if(!withdrawals.length){el.innerHTML='<div class="empty">출금 내역 없음</div>';sum.innerHTML='';return;}

    const total=withdrawals.reduce((s,t)=>s+(t.amount||0),0);
    sum.innerHTML=`<div class="summary-box"><div class="summary-label">총 출금</div><div class="summary-val" style="color:#ef5350">-${fmt(total)}</div></div>`;

    const cats={};
    withdrawals.forEach(t=>{
        const name=t.counterparty||'미분류';
        if(!cats[name])cats[name]={amount:0,count:0};
        cats[name].amount+=t.amount||0;
        cats[name].count++;
    });

    const sorted=Object.entries(cats).sort((a,b)=>b[1].amount-a[1].amount);
    let html='';
    sorted.forEach(([name,data])=>{
        html+=`<div class="cat-item"><div><div class="cat-name">${name}</div><div class="cat-count">${data.count}건</div></div><div class="cat-amount">-${fmt(data.amount)}</div></div>`;
    });
    el.innerHTML=html;
}

// --- 로그 렌더링 ---
function setLogFilter(tag){
    logFilterTag=tag;
    document.querySelectorAll('#logFilter .filter-btn').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    renderLogs();
}

function renderLogs(){
    const el=document.getElementById('logContent');
    if(!logs.length){el.innerHTML='<div class="empty">로그 없음</div>';return;}

    let filtered=logs;
    if(logFilterTag!=='all')filtered=logs.filter(l=>(l.tag||'')===logFilterTag);

    const html=filtered.slice(0,200).map(l=>{
        const tagCls=(l.tag||'').replace(/[\[\]]/g,'').toLowerCase();
        return`<div class="log-item"><span class="log-ts">${tsFmt(l.ts)}</span><span class="log-tag ${tagCls}">${l.tag||''}</span><span class="log-msg">${l.msg||''}</span></div>`;
    }).join('');
    el.innerHTML=html||'<div class="empty">필터 결과 없음</div>';
}

// --- 권한 렌더링 ---
function renderPermissions(){
    const el=document.getElementById('permContent');
    if(typeof NativeBridge!=='undefined'){
        try{
            const json=NativeBridge.getPermissions();
            const p=JSON.parse(json);
            const ver=NativeBridge.getAppVersion();
            el.innerHTML=`
                <div class="perm-item"><span class="perm-name">알림 접근 권한</span><span class="perm-status ${p.notification?'on':'off'}" onclick="${!p.notification?'NativeBridge.openNotificationSettings()':''}">${p.notification?'활성':'비활성'}</span></div>
                <div class="perm-item"><span class="perm-name">접근성 권한 (BBQ)</span><span class="perm-status ${p.accessibility?'on':'off'}" onclick="${!p.accessibility?'NativeBridge.openAccessibilitySettings()':''}">${p.accessibility?'활성':'비활성'}</span></div>
                <div class="perm-item"><span class="perm-name">앱 버전</span><span style="color:#888">${ver}</span></div>
            `;
            document.getElementById('versionInfo').textContent=`BankTotal v${ver}`;
        }catch(e){
            el.innerHTML='<div class="empty">권한 정보 로드 실패</div>';
        }
    }else{
        el.innerHTML=`
            <div class="perm-item"><span class="perm-name">알림 접근 권한</span><span class="perm-status off">웹 모드</span></div>
            <div class="perm-item"><span class="perm-name">접근성 권한 (BBQ)</span><span class="perm-status off">웹 모드</span></div>
            <div class="perm-item"><span class="perm-name">모드</span><span style="color:#4fc3f7">웹 브라우저</span></div>
        `;
    }
}

// --- 정산 렌더링 ---
// 정산 시뮬레이션 — 개별 항목 상태 (_key → {ex, sh})
let itemState={};
try{const s=localStorage.getItem('settleItemState');if(s)itemState=JSON.parse(s)}catch(e){}
function saveItemState(){try{localStorage.setItem('settleItemState',JSON.stringify(itemState))}catch(e){}}
function ist(k){if(!itemState[k])itemState[k]={ex:false,sh:0,st:''};return itemState[k]}
function setItemStatus(k,st){const s=ist(k);s.st=(s.st===st)?'':st;saveItemState();renderSettle()}
function deleteSettleItem(id){
    if(!confirm('삭제하시겠습니까?'))return;
    const mi=settleManual.findIndex(m=>m._id===id);
    if(mi>=0){fetch(FB+'/banktotal/settle/manual/'+id+'.json',{method:'DELETE'});settleManual.splice(mi,1)}
    else{const ai=settleAuto.findIndex(a=>a._id===id);if(ai>=0){fetch(FB+'/banktotal/settle/auto/'+id+'.json',{method:'DELETE'});settleAuto.splice(ai,1)}}
    renderSettle();
}
function toggleItem(k){ist(k).ex=!ist(k).ex;saveItemState();renderSettle()}

// 스와이프 드래그 — 좌우=날짜이동, 탭=포함/제외
let swSt=null;
function swStart(e,key){swSt={key,sx:e.touches[0].clientX,sy:e.touches[0].clientY,el:e.currentTarget,sw:false,t0:Date.now(),moved:false}}
document.addEventListener('touchmove',function(e){
    if(!swSt)return;
    const dx=e.touches[0].clientX-swSt.sx;
    const dy=e.touches[0].clientY-swSt.sy;
    swSt.dx=dx;swSt.dy=dy;
    if(Math.abs(dx)>8||Math.abs(dy)>8)swSt.moved=true;
    if(!swSt.sw&&Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>20){swSt.sw=true}
    if(swSt.sw){
        e.preventDefault();
        swSt.el.style.transform=`translateX(${dx}px)`;
        swSt.el.style.opacity=Math.max(0.3,1-Math.abs(dx)/200);
    }
},{passive:false});
document.addEventListener('touchend',function(e){
    if(!swSt)return;
    swSt.el.style.transform='';swSt.el.style.opacity='';swSt.el.style.transition='transform .2s,opacity .2s';
    setTimeout(()=>{if(swSt&&swSt.el)swSt.el.style.transition=''},200);
    const dt=Date.now()-swSt.t0;
    if(swSt.sw){
        const dx=swSt.dx||0;
        const days=dx>30?1:dx<-30?-1:0;
        if(days!==0){ist(swSt.key).sh+=days;saveItemState();renderSettle()}
    }else if(!swSt.moved&&dt<300){
        toggleItem(swSt.key);
    }
    swSt=null;
})

function renderSettle(){
    const sum=document.getElementById('settleSummary');
    const el=document.getElementById('settleContent');
    const currentBalance=Object.values(accounts).reduce((s,a)=>s+((a.balance||0)>=0?(a.balance||0):0),0);
    const now=new Date();now.setHours(0,0,0,0);
    const dayNames=['일','월','화','수','목','금','토'];

    const items=generateAllItems(settleManual,settleAuto,30);
    // SFA: 당일 최초 BLOCK 값(sfa_daily)을 고정값으로 사용 + 제네시스 차감
    const genesisKeywords=['제네시스','genesis','올원오픈주','토스 (주)제','(주)제'];
    // 전각→반각 정규화 (은행마다 （）vs() 등 표기 다름)
    function normCP(s){return s.replace(/[\uff08]/g,'(').replace(/[\uff09]/g,')').replace(/[\u3000\uff10-\uff5a]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xfee0)).replace(/\u3000/g,' ');}
    items.forEach(u=>{
        if(u.name==='물류'||u.name==='SFA'){
            const dk=dateFmt(u.date);
            const ymd=new Date(u.date);
            const dailyKey=ymd.getFullYear()+'-'+(ymd.getMonth()+1).toString().padStart(2,'0')+'-'+ymd.getDate().toString().padStart(2,'0');
            if(sfaDaily[dailyKey]&&sfaDaily[dailyKey].amount>0){
                // sfa_daily 확인됨 → SFA로 전환, 실제 금액 사용
                u.name='SFA';
                u.amount=sfaDaily[dailyKey].amount;
                u.isBlock=true;
                u._sfaKey=dailyKey;
                // 제네시스 출금 차감
                const genTotal=transactions.filter(t=>{
                    if(t.type!=='출금')return false;
                    const cp=normCP((t.counterparty||'').toLowerCase());
                    if(!genesisKeywords.some(k=>cp.includes(k.toLowerCase())))return false;
                    return dateFmt(t.ts)===dk;
                }).reduce((s,t)=>s+(t.amount||0),0);
                if(genTotal>0)u.amount=Math.max(0,u.amount-genTotal);
            }
            // sfa_daily 없으면 물류 300만 그대로 표시
        }
    });
    const included=items.filter(u=>!u.excluded);
    const todayIncluded=included.filter(u=>dateFmt(u.date)===dateFmt(now.getTime()));
    const todayIn=todayIncluded.filter(u=>u.type==='입금').reduce((s,u)=>s+u.amount,0);
    const todayOut=todayIncluded.filter(u=>u.type==='출금').reduce((s,u)=>s+u.amount,0);
    const todayPredicted=currentBalance+todayIn-todayOut;
    const expectedIn=included.filter(u=>u.type==='입금').reduce((s,u)=>s+u.amount,0);
    const expectedOut=included.filter(u=>u.type==='출금').reduce((s,u)=>s+u.amount,0);
    const predicted=currentBalance+expectedIn-expectedOut;
    const exCnt=items.filter(u=>u.excluded).length;

    sum.innerHTML=`<div class="summary-row">
        <div class="summary-box"><div class="summary-label">오늘 예상</div><div class="summary-val" style="font-size:18px;color:${todayPredicted>=0?'#4fc3f7':'#ef5350'}">${fmt(todayPredicted)}</div></div>
        <div class="summary-box"><div class="summary-label">30일 예상</div><div class="summary-val" style="font-size:14px;color:${predicted>=0?'#888':'#ef5350'}">${fmt(predicted)}</div></div>
    </div>${exCnt?`<div style="text-align:center;font-size:11px;color:#ff9800;margin-top:4px">${exCnt}건 제외중</div>`:''}`;

    // 날짜 지난 항목 처리: 출금만 이월, 입금은 자동 제외 (잔고에 이미 반영)
    const todayTs=now.getTime();
    items.forEach(u=>{
        if(u.date<todayTs&&!u.excluded){
            if(u.type==='입금'){u.excluded=true;u._autoExclude='이월삭제';}
            else u.date=todayTs; // 출금만 오늘로 이월
        }
    });
    // 중복 제거: 같은 날짜+같은 이름+같은 타입 → 최초 1건만 유지
    const seenByDateName={};
    for(let i=items.length-1;i>=0;i--){
        const u=items[i];
        const dk=dateFmt(u.date)+'_'+u.name+'_'+u.type;
        if(seenByDateName[dk]){items.splice(i,1);}
        else seenByDateName[dk]=true;
    }
    // 날짜별 그룹 + 활성 상단, 제외 하단 정렬
    const upByDate={};
    items.forEach(u=>{const d=dateFmt(u.date);if(!upByDate[d])upByDate[d]=[];upByDate[d].push(u)});
    Object.values(upByDate).forEach(arr=>arr.sort((a,b)=>{
        if(a.excluded!==b.excluded)return a.excluded?1:-1;
        if(a.type!==b.type)return a.type==='입금'?-1:1;
        return 0;
    }));

    let html=`<div style="display:flex;align-items:center;padding:4px;border-bottom:1px solid #333">
        <span style="min-width:40px;font-size:10px;color:#666">상태</span>
        <span style="flex:1;font-size:10px;color:#666">내역 <span style="color:#444">탭=제외 · 드래그=이동</span></span>
        <span style="min-width:55px;text-align:right;font-size:10px;color:#666">금액</span>
        <span style="min-width:60px;text-align:right;font-size:10px;color:#666">잔고</span>
        <span style="min-width:18px"></span>
    </div>`;

    html+=`<div style="display:flex;align-items:center;padding:6px 4px;border-bottom:1px solid #1a1a1a;background:#4fc3f711">
        <span style="min-width:40px;font-size:12px;color:#4fc3f7">현재</span>
        <span style="flex:1;font-size:12px;color:#aaa">소계</span>
        <span style="min-width:55px"></span>
        <span style="min-width:60px;text-align:right;font-size:14px;font-weight:bold;color:#4fc3f7">${fmt(currentBalance)}</span>
        <span style="min-width:18px"></span>
    </div>`;
    // 계좌 리스트
    const acctList=Object.values(accounts).filter(a=>a.balance!==undefined&&!((a.bankName||a.bank||'')+(a.account||a.accountNumber||'')).toUpperCase().match(/BBQ|BLOCK|SFA/)).sort((a,b)=>(b.balance||0)-(a.balance||0));
    acctList.forEach(a=>{
        const bn=a.bankName||a.bank||'';
        const bal_=a.balance||0;
        const c=bal_<0?'#ef5350':bal_>0?'#aaa':'#555';
        html+=`<div style="display:flex;align-items:center;padding:3px 4px 3px 20px;border-bottom:1px solid #111">
            <span style="min-width:40px;font-size:10px;color:#555"></span>
            <span style="flex:1;font-size:11px;color:#666">${bn} ${a.account||a.accountNumber||''}</span>
            <span style="min-width:55px"></span>
            <span style="min-width:60px;text-align:right;font-size:11px;color:${c}">${fmt(bal_)}</span>
            <span style="min-width:18px"></span>
        </div>`;
    });

    let bal=currentBalance;
    for(let i=0;i<30;i++){
        const d=new Date(now.getTime()+i*86400000);
        const dk=dateFmt(d.getTime());
        const dayName=dayNames[d.getDay()];
        const dayItems=upByDate[dk]||[];
        const isToday=i===0;
        const dayColor=d.getDay()===0?'#ef5350':d.getDay()===6?'#4fc3f7':'#888';
        if(dayItems.length){
            // 날짜 헤더
            const hdrBg=isToday?'#4fc3f722':'#ffffff08';
            html+=`<div style="padding:6px 4px 2px;background:${hdrBg};border-top:1px solid #333;margin-top:2px">
                <span style="font-size:12px;font-weight:bold;color:${dayColor}">${d.getMonth()+1}/${d.getDate()}(${dayName})${isToday?' 오늘':''}</span>
            </div>`;
            dayItems.forEach((u,j)=>{
                const isIn=u.type==='입금';
                const delta=isIn?u.amount:-u.amount;
                if(!u.excluded)bal+=delta;
                const op=u.excluded?'opacity:.35;':'';
                const iSt=ist(u._key).st||'';
                const stBg=iSt==='confirmed'?'background:#4caf5018;':iSt==='pending'?'background:#ff980018;':'';
                const bg=u.excluded?'':stBg||(u.isBlock?'background:#e91e6311;':u.isPending?'background:#ff980011;':isToday?'background:#4fc3f711;':'');
                const amtC=isIn?'#4caf50':'#ef5350';
                const nmC=u.isBlock?'#e91e63':u.isPending?'#ff9800':u.overdue?'#ff9800':'#aaa';
                const tag=u.isPending?' ⚡':u._autoExclude?' ('+u._autoExclude+')':'';
                const stIcon=iSt==='confirmed'?'<span style="color:#4caf50;font-size:10px;margin-right:2px">●</span>':iSt==='pending'?'<span style="color:#ff9800;font-size:10px;margin-right:2px">●</span>':'';
                const stk=u.excluded?'text-decoration:line-through;':'';
                const cfBg=iSt==='confirmed'?'background:#4caf50;color:#fff;':'background:#333;color:#888;';
                const pdBg=iSt==='pending'?'background:#ff9800;color:#fff;':'background:#333;color:#888;';
                html+=`<div style="display:flex;align-items:center;padding:6px 4px;border-bottom:1px solid #1a1a1a;${bg}${op}">
                    <span style="min-width:40px;display:flex;gap:2px">
                        <span onclick="setItemStatus('${u._key}','confirmed')" style="font-size:9px;padding:2px 4px;border-radius:3px;cursor:pointer;${cfBg}">확</span>
                        <span onclick="setItemStatus('${u._key}','pending')" style="font-size:9px;padding:2px 4px;border-radius:3px;cursor:pointer;${pdBg}">미</span>
                    </span>
                    <span ontouchstart="swStart(event,'${u._key}')" style="flex:1;font-size:12px;color:${nmC};cursor:pointer;touch-action:pan-y">${stIcon}${u.name}${u.overdue?' (지연)':''}${tag}</span>
                    <span onclick="${u._sfaKey?`editSfaDaily('${u._sfaKey}',${u.amount})`:`editSettleAmount('${u._id}',${u.amount})`}" style="min-width:55px;text-align:right;font-size:12px;color:${amtC};${stk};cursor:pointer">${isIn?'+':'-'}${fmt(u.amount)}</span>
                    <span style="min-width:60px;text-align:right;font-size:13px;font-weight:bold;color:${bal>=0?'#e0e0e0':'#ef5350'}">${fmt(bal)}</span>
                    <span onclick="deleteSettleItem('${u._id}')" style="font-size:10px;padding:2px 4px;margin-left:3px;color:#666;cursor:pointer">✕</span>
                </div>`;
            });
        }else{
            const bg=isToday?'background:#4fc3f711;':'';
            html+=`<div style="display:flex;align-items:center;padding:6px 4px;border-bottom:1px solid #1a1a1a;${bg}">
                <span style="min-width:40px;font-size:11px;color:${dayColor}">${dk.slice(5)}</span>
                <span style="flex:1;font-size:11px;color:${dayColor}">(${dayName})</span>
                <span style="min-width:55px"></span>
                <span style="min-width:60px;text-align:right;font-size:13px;color:#555">${fmt(bal)}</span>
                <span style="min-width:18px"></span>
            </div>`;
        }
    }
    el.innerHTML=html;
}

function editSfaDaily(key,cur){
    const v=prompt('SFA 초기 BLOCK 금액 수정 ('+key+')',cur||'');
    if(v===null)return;
    const amt=parseInt(v.replace(/[^0-9]/g,''),10)||0;
    fetch(FB+'/banktotal/sfa_daily/'+key+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:amt,ts:Date.now()})});
    sfaDaily[key]={amount:amt,ts:Date.now()};
    renderSettle();
}
function editSettleAmount(id,cur){
    const v=prompt('금액 수정 (숫자만)',cur||'');
    if(v===null)return;
    const amt=parseInt(v.replace(/[^0-9]/g,''),10)||0;
    // Firebase에서 manual/auto 구분해서 업데이트
    const mIdx=settleManual.findIndex(m=>m._id===id);
    if(mIdx>=0){
        fetch(FB+'/banktotal/settle/manual/'+id+'.json',{method:'PATCH',body:JSON.stringify({amount:amt})});
        settleManual[mIdx].amount=amt;
    }else{
        const aIdx=settleAuto.findIndex(a=>a._id===id);
        if(aIdx>=0){
            fetch(FB+'/banktotal/settle/auto/'+id+'.json',{method:'PATCH',body:JSON.stringify({amount:amt})});
            settleAuto[aIdx].amount=amt;
        }
    }
    renderSettle();
}

// --- AI 자동 금액 보정: 새 출금 발생 시 고정비 매칭 판단 ---
let _correctCooldown=0;
function checkSettleCorrection(newOutTxs){
    // 쿨다운 5분
    if(Date.now()-_correctCooldown<300000)return;
    // 0원 항목 또는 금액 차이 큰 항목 대상
    const candidates=settleManual.filter(m=>m.cycle==='monthly');
    if(!candidates.length)return;
    const key=loadAiKey();
    if(!key)return;
    _correctCooldown=Date.now();

    const txList=newOutTxs.map(t=>(t.counterparty||t.bank||'')+' '+t.amount+'원').join('\n');
    const settleList=candidates.map(c=>c.name+' (매월'+c.dayOfMonth+'일, 현재:'+c.amount+'원)').join('\n');

    const prompt=`새로 발생한 출금 거래와 월 고정비 항목을 비교하세요.

[새 출금 거래]
${txList}

[월 고정비 목록]
${settleList}

[핵심 규칙 — 반드시 준수]
1. 매칭은 거래상대 이름과 항목명이 관련 있을 때만 (예: 미소금융→미소, KT→kt인터넷)
2. 이름이 무관한 항목에 매칭 절대 금지 (예: 미소금융을 skylife에 매칭하면 안 됨)
3. 확실한 매칭(이름 일치): confidence="high" → 자동 적용됨
4. 불확실한 매칭(금액만 비슷): confidence="low" → 사용자에게 제안만
5. 날짜: 공휴일/주말/미납 밀림은 변경하지 마세요
6. 날짜: "납부기한", "결제일" 등 확정일이 원문에 있을 때만 dayOfMonth 변경
7. 매칭 불가하면 빈 배열 []

응답 형식 (순수 JSON만, 설명 없이):
[{"name":"항목명","amount":보정금액,"confidence":"high또는low","reason":"매칭근거","dayOfMonth":확정일(선택)}]`;

    fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key='+key,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
    }).then(r=>r.json()).then(d=>{
        const txt=d.candidates?.[0]?.content?.parts?.[0]?.text||'';
        const clean=txt.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim();
        try{
            const matches=JSON.parse(clean);
            if(!Array.isArray(matches)||!matches.length)return;
            let autoApplied=0;
            const autoChanges=[];
            const suggestions=[];
            matches.forEach(m=>{
                const item=candidates.find(c=>c.name===m.name);
                if(!item)return;
                const isHigh=m.confidence==='high';
                const patch={};
                let desc=item.name+':';
                if(m.amount&&m.amount>0&&item.amount!==m.amount){
                    patch.amount=m.amount;
                    desc+=' '+(item.amount?fmt(item.amount):'0')+'→'+fmt(m.amount)+'원';
                }
                if(m.dayOfMonth&&m.dayOfMonth!==item.dayOfMonth){
                    patch.dayOfMonth=m.dayOfMonth;
                    desc+=' 날짜'+item.dayOfMonth+'→'+m.dayOfMonth+'일';
                }
                if(!Object.keys(patch).length)return;
                if(isHigh){
                    // 확실한 매칭 → 자동 적용
                    Object.assign(item,patch);
                    fetch(FB+'/banktotal/settle/manual/'+item._id+'.json',{method:'PATCH',body:JSON.stringify(patch)});
                    autoChanges.push('✓ '+desc+(m.reason?' ('+m.reason+')':''));
                    autoApplied++;
                }else{
                    // 불확실 → 제안만 (버튼으로 수동 적용)
                    suggestions.push({item,patch,desc:desc+(m.reason?' ('+m.reason+')':'')});
                }
            });
            const el=document.getElementById('aiMsgs');
            if(autoApplied>0){
                renderSettle();
                const msg='[자동보정] '+autoApplied+'건\n'+autoChanges.join('\n');
                if(el){aiMessages.push({role:'ai',text:msg});renderAiMsgs();}
            }
            if(suggestions.length){
                let msg='[보정 제안] 확인 후 적용하세요\n';
                suggestions.forEach((s,i)=>{msg+=s.desc+'\n';});
                aiMessages.push({role:'ai',text:msg});
                // 각 제안에 적용 버튼 추가
                renderAiMsgs();
                if(el){
                    let btns='';
                    suggestions.forEach((s,i)=>{
                        const pid='_sgst'+Date.now()+'_'+i;
                        btns+=`<button id="${pid}" onclick="(function(){const p=${JSON.stringify(s.patch).replace(/"/g,'&quot;')};const id='${s.item._id}';fetch('${FB}/banktotal/settle/manual/'+id+'.json',{method:'PATCH',body:JSON.stringify(p)}).then(()=>{Object.assign(settleManual.find(x=>x._id===id)||{},p);renderSettle();document.getElementById('${pid}').textContent='적용됨';document.getElementById('${pid}').disabled=true;aiMessages.push({role:'ai',text:'✓ ${s.item.name} 보정 적용됨'});renderAiMsgs();});})()" style="margin:4px;padding:4px 12px;background:#2e7d32;color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer">${s.item.name} 적용</button>`;
                    });
                    el.innerHTML+=`<div style="padding:4px 8px">${btns}</div>`;
                    el.scrollTop=el.scrollHeight;
                }
            }
        }catch(e){}
    }).catch(()=>{});
}

function generateAllItems(manual,auto,days){
    const result=[];
    const now=new Date();now.setHours(0,0,0,0);
    const end=new Date(now.getTime()+days*86400000);
    manual.forEach(m=>{
        if(m.cycle==='none'){
            const key=m._id;
            const st=ist(key);
            const day=Math.max(0,Math.min(29,st.sh));
            const d=new Date(now.getTime()+day*86400000);
            result.push({name:m.name,amount:m.amount||0,type:m.type||'출금',date:d.getTime(),_key:key,_id:m._id,isPending:true,excluded:st.ex});
            return;
        }
        // 과거 1일만 탐색 (어제 미처리 이월용, 그 이전은 잔고에 이미 반영)
        const lookBack=(m.cycle==='weekly'||m.cycle==='monthly')?1:0;
        for(let i=-lookBack;i<days;i++){
            const d=new Date(now.getTime()+i*86400000);
            let match=false;
            if(m.cycle==='once'&&m.date){
                const od=new Date(m.date+'T00:00:00+09:00');
                if(d.getFullYear()===od.getFullYear()&&d.getMonth()===od.getMonth()&&d.getDate()===od.getDate())match=true;
            }
            if(m.cycle==='daily')match=true;
            if(m.cycle==='monthly'&&d.getDate()===(m.dayOfMonth||1))match=true;
            if(m.cycle==='weekly'){
                if(d.getDay()===(m.dayOfWeek||0))match=true;
                // 일요일(0) 물류는 토요일(6)부터 표기
                if((m.dayOfWeek||0)===0&&d.getDay()===6&&m.name==='물류'){match=true;}
            }
            if(match){
                const key=m._id+'_'+(i<0?'p'+(-i):i);
                const st=ist(key);
                const adjDay=Math.max(0,Math.min(29,i+st.sh));
                const nd=new Date(now.getTime()+adjDay*86400000);
                // 과거 항목은 이월 대상 (출금→오늘, 입금→자동제외는 renderSettle에서)
                result.push({name:m.name,amount:m.amount||0,type:m.type||'출금',date:nd.getTime(),_key:key,_id:m._id,excluded:st.ex});
            }
        }
    });
    auto.forEach(a=>{
        if(a.cycle==='none'){
            const key=a._id;
            const st=ist(key);
            const day=Math.max(0,Math.min(29,st.sh));
            const d=new Date(now.getTime()+day*86400000);
            result.push({name:a.name||a.source||'밀림',amount:a.amount||0,type:a.type||'출금',date:d.getTime(),_key:key,_id:a._id,isPending:true,excluded:st.ex});
            return;
        }
        if(!a.dueDate&&!a.amount)return;
        const due=a.dueDate||now.getTime();
        const tp=a.type||'출금';
        const showDate=(tp==='출금'&&due<now.getTime())?now.getTime():due;
        if(showDate<=end.getTime()){
            const origDay=Math.round((showDate-now.getTime())/86400000);
            const key=a._id;
            const st=ist(key);
            const newDay=Math.max(0,Math.min(29,origDay+st.sh));
            const nd=new Date(now.getTime()+newDay*86400000);
            result.push({name:a.name||a.source||'고지서',amount:a.amount||0,type:tp,date:nd.getTime(),_key:key,_id:a._id,overdue:a.dueDate&&a.dueDate<now.getTime(),excluded:st.ex});
        }
    });
    return result.sort((a,b)=>a.date-b.date);
}

function deleteSettle(id){
    if(!confirm('삭제하시겠습니까?'))return;
    fetch(FB+'/banktotal/settle/manual/'+id+'.json',{method:'DELETE'}).catch(()=>alert('삭제 실패'));
}

function deleteAutoSettle(id){
    if(!confirm('삭제하시겠습니까?'))return;
    fetch(FB+'/banktotal/settle/auto/'+id+'.json',{method:'DELETE'}).catch(()=>alert('삭제 실패'));
}

// --- AI 재무상담 (Gemini API) ---
let aiMessages=[];

function promptAiKey(){
    const cur=loadAiKey();
    const val=prompt('Gemini API Key'+(cur?' (현재 설정됨)':''),cur||'');
    if(val!==null&&val.trim()){
        localStorage.setItem('gemini_api_key',val.trim());
        if(typeof NativeBridge!=='undefined')try{NativeBridge.setGeminiKey(val.trim())}catch(e){}
        document.getElementById('aiKeyBtn').style.color='#4caf50';
    }
}

function loadAiKey(){
    // 네이티브 키 우선 → localStorage → Firebase 순
    let k=localStorage.getItem('gemini_api_key')||'';
    if(typeof NativeBridge!=='undefined'){
        try{
            const nk=NativeBridge.getGeminiKey();
            if(nk){k=nk;localStorage.setItem('gemini_api_key',k)}
            else if(k){NativeBridge.setGeminiKey(k)}
        }catch(e){}
    }
    if(!k){
        // Firebase에서 로드 (비동기, 다음 호출부터 사용)
        fetch(FB+'/banktotal/settings/gemini_key.json').then(r=>r.json()).then(d=>{
            if(d&&typeof d==='string'){
                localStorage.setItem('gemini_api_key',d);
                if(typeof NativeBridge!=='undefined')try{NativeBridge.setGeminiKey(d)}catch(e){}
                const st=document.getElementById('aiKeyStatus');
                if(st){st.textContent='설정됨';st.style.color='#4caf50'}
            }
        }).catch(()=>{});
    }
    return k;
}

function buildFinCtx(){
    const accs=Object.values(accounts);
    const totalBal=accs.reduce((s,a)=>s+(a.balance||0),0);
    let c='';
    if(aiRules.business){
        c+=`[사업 정보] ${aiRules.business}\n`;
        if(aiRules.income)c+='수입원: '+(Array.isArray(aiRules.income)?aiRules.income.join(', '):aiRules.income)+'\n';
        if(aiRules.expenses)c+='지출: '+(Array.isArray(aiRules.expenses)?aiRules.expenses.join(', '):aiRules.expenses)+'\n';
        if(aiRules.rules)c+='규칙: '+(Array.isArray(aiRules.rules)?aiRules.rules.join(' / '):aiRules.rules)+'\n\n';
    }
    c+=`[현재 재무]\n총 잔고: ${totalBal.toLocaleString()}원\n`;
    accs.forEach(a=>{c+=`- ${a.bank||''} ${a.account||''}: ${(a.balance||0).toLocaleString()}원\n`});

    const now=Date.now();
    const recent=transactions.filter(t=>t.ts&&now-t.ts<30*86400000&&!t._excluded);
    const tIn=recent.filter(t=>t.type==='입금').reduce((s,t)=>s+(t.amount||0),0);
    const tOut=recent.filter(t=>t.type==='출금').reduce((s,t)=>s+(t.amount||0),0);
    c+=`\n[최근 30일] 입금: ${tIn.toLocaleString()}원, 출금: ${tOut.toLocaleString()}원\n`;

    const cats={};
    recent.filter(t=>t.type==='출금').forEach(t=>{const n=t.counterparty||'미분류';cats[n]=(cats[n]||0)+(t.amount||0)});
    if(Object.keys(cats).length){
        c+='출금 카테고리:\n';
        Object.entries(cats).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(([n,a])=>{c+=`- ${n}: ${a.toLocaleString()}원\n`});
    }

    c+='\n최근 거래:\n';
    recent.slice(0,20).forEach(t=>{
        const d=new Date(t.ts);
        c+=`- ${d.getMonth()+1}/${d.getDate()} ${t.type} ${(t.amount||0).toLocaleString()}원 ${t.counterparty||t.bank||''}\n`;
    });

    if(settleManual.length){
        c+='\n[정기 항목]\n';
        settleManual.forEach(m=>{
            const cycleLabel=m.cycle==='none'?'밀린금액':m.cycle==='daily'?'매일':m.cycle==='weekly'?'매주':'매월';
            c+=`- ${m.name}: ${m.type} ${(m.amount||0).toLocaleString()}원 (${cycleLabel})\n`;
        });
    }
    if(settleAuto.length){
        c+='\n[예정 고지서]\n';
        settleAuto.forEach(a=>{c+=`- ${a.name||'고지서'}: ${(a.amount||0).toLocaleString()}원\n`});
    }
    return c;
}

let _aiAbort=null;
function askAi(q){
    try{ _askAiInner(q) }catch(e){ alert('askAi에러:'+e.message) }
}
async function _askAiInner(q){
    if(!q){q=(document.getElementById('aiInput').value||'').trim();if(!q)return}
    const key=loadAiKey();
    if(!key){alert('Gemini API Key를 입력하세요');return}

    document.getElementById('aiInput').value='';
    aiMessages.push({role:'user',text:q});
    aiMessages.push({role:'bot',text:'연결중...'});
    renderAiMsgs();

    const btn=document.getElementById('aiSendBtn');
    _aiAbort=new AbortController();
    btn.disabled=false;btn.textContent='중지';btn.onclick=()=>{if(_aiAbort)_aiAbort.abort();};

    const ctx=buildFinCtx();
    const sys=`당신은 BankTotal 입력 어시스턴트입니다. 주 역할은 항목등록과 규칙관리입니다.

[핵심 역할 — 즉시 실행]
- 항목 등록/삭제: 사용자가 말하면 바로 액션 실행. 확인은 한줄로 짧게.
- 규칙 등록/수정: 사업정보, 분류규칙, 직원정보 등
- 사진 분석: 고지서/영수증에서 금액 추출 → 등록

[재무분석은 요청시에만]
"분석해줘", "어떻게 되나", "예측" 등 명시적 요청이 있을 때만 상세 분석.
일반 입력에는 분석 없이 등록만 실행.

[응답 스타일]
- 최대한 짧게. "등록완료: 매일입금 130만원" 수준.
- 불필요한 설명, 인사, 이모지 금지.

${ctx}

[액션 태그 — 답변 맨 끝에 추가]
등록: [ACTION]{"act":"add","name":"항목명","amount":숫자,"txType":"입금/출금","cycle":"daily/weekly/monthly/none","day":숫자}[/ACTION]
- daily=매일, weekly=매주(day:0일~6토), monthly=매월(day:1~31), none=날짜미정(밀린금액)
- 130만원→1300000 숫자변환 필수
삭제: [ACTION]{"act":"del","name":"항목명"}[/ACTION]
규칙추가: [ACTION]{"act":"add_rule","rule":"내용"}[/ACTION]
규칙삭제: [ACTION]{"act":"del_rule","rule":"내용"}[/ACTION]
정보수정: [ACTION]{"act":"set_info","key":"income/expenses/accounts/business/people","value":"값"}[/ACTION]

여러 액션은 각각 별도 [ACTION]...[/ACTION]으로.`;

    let body;
    try{
        body=JSON.stringify({contents:[{parts:[{text:sys+'\n\n사용자: '+q}]}]});
    }catch(be){aiMessages[aiMessages.length-1].text='JSON에러:'+be.message;_aiDone(btn);return}

    const url='https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:streamGenerateContent?alt=sse&key='+key;
    const t0=Date.now();
    let fullText='';
    try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body,signal:_aiAbort.signal});
        if(!res.ok){
            const err=await res.text().catch(()=>'');
            let msg='API에러 '+res.status;
            try{const j=JSON.parse(err);msg=j?.error?.message||msg;}catch(e){}
            aiMessages[aiMessages.length-1].text=msg;_aiDone(btn);return;
        }
        const reader=res.body.getReader();
        const dec=new TextDecoder();
        let buf='';
        while(true){
            const{done,value}=await reader.read();
            if(done)break;
            buf+=dec.decode(value,{stream:true});
            const lines=buf.split('\n');
            buf=lines.pop()||'';
            for(const line of lines){
                if(!line.startsWith('data: '))continue;
                try{
                    const d=JSON.parse(line.slice(6));
                    const t=d?.candidates?.[0]?.content?.parts?.[0]?.text||'';
                    if(t){fullText+=t;aiMessages[aiMessages.length-1].text=fullText;renderAiMsgs();}
                }catch(e){}
            }
        }
        if(buf.startsWith('data: ')){try{const d=JSON.parse(buf.slice(6));const t=d?.candidates?.[0]?.content?.parts?.[0]?.text||'';if(t)fullText+=t;}catch(e){}}
        // 스트림 완료 후 액션 처리
        const actionMatches=[...fullText.matchAll(/\[ACTION\](.*?)\[\/ACTION\]/g)];
        for(const m of actionMatches){try{await executeAiAction(JSON.parse(m[1]))}catch(e){}}
        if(actionMatches.length)fullText=fullText.replace(/\[ACTION\].*?\[\/ACTION\]/g,'').trim();
        aiMessages[aiMessages.length-1].text=fullText||'응답 없음';
    }catch(e){
        if(e.name==='AbortError'){aiMessages[aiMessages.length-1].text=fullText?(fullText+'\n(중지됨)'):'중지됨';}
        else{aiMessages[aiMessages.length-1].text='에러: '+e.message;}
    }
    _aiDone(btn);
}
function _aiDone(btn){_aiAbort=null;btn.disabled=false;btn.textContent='전송';btn.onclick=()=>askAi();renderAiMsgs();}

function loadLatestImage(){
    if(typeof NativeBridge!=='undefined'){
        try{
            const b64=NativeBridge.getLatestImage();
            if(b64&&b64.length>100){analyzeBase64(b64,'image/jpeg');return}
        }catch(e){}
    }
    document.getElementById('aiFileInput').click();
}

async function analyzeBase64(base64,mime){
    const key=loadAiKey();
    if(!key){alert('Gemini API Key를 먼저 설정하세요');return}

    aiMessages.push({role:'user',text:'[최근 사진 분석]'});
    aiMessages.push({role:'bot',text:'이미지 분석 중...'});
    renderAiMsgs();

    const btn=document.getElementById('aiSendBtn');
    btn.disabled=true;btn.textContent='...';

    const ctx=buildFinCtx();
    const prompt=`당신은 개인 재무 상담사입니다. 이 이미지를 분석하세요.

고지서/청구서/영수증/은행명세서/카드내역 등 금융 문서라면:
- 항목명, 금액, 납기일, 입금/출금 여부를 추출하세요
- 정기 항목이면 등록 액션을 추가하세요
금융 문서가 아니면 이미지 내용을 간단히 설명하세요.

${ctx}

[액션 형식]
등록: [ACTION]{"act":"add","name":"항목명","amount":금액,"txType":"입금또는출금","cycle":"daily또는weekly또는monthly또는none","day":숫자}[/ACTION]`;

    try{
        const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key='+key,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({contents:[{parts:[
                {text:prompt},
                {inline_data:{mime_type:mime,data:base64}}
            ]}]})
        });
        const d=await r.json();
        let reply=d?.candidates?.[0]?.content?.parts?.[0]?.text||d?.error?.message||'분석 실패';
        const actionMatches=[...reply.matchAll(/\[ACTION\](.*?)\[\/ACTION\]/g)];
        for(const m of actionMatches){try{await executeAiAction(JSON.parse(m[1]))}catch(e){}}
        if(actionMatches.length)reply=reply.replace(/\[ACTION\].*?\[\/ACTION\]/g,'').trim();
        aiMessages[aiMessages.length-1].text=reply;
    }catch(e){
        aiMessages[aiMessages.length-1].text='오류: '+e.message;
    }
    btn.disabled=false;btn.textContent='AI';
    renderAiMsgs();
}

async function analyzeImage(input){
    const file=input.files[0];if(!file)return;
    const key=loadAiKey();
    if(!key){alert('Gemini API Key를 먼저 설정하세요');return}

    const reader=new FileReader();
    reader.onload=async function(){
        const base64=reader.result.split(',')[1];
        const mime=file.type||'image/jpeg';

        aiMessages.push({role:'user',text:'[이미지 분석 요청]'});
        aiMessages.push({role:'bot',text:'이미지 분석 중...'});
        renderAiMsgs();

        const btn=document.getElementById('aiSendBtn');
        btn.disabled=true;btn.textContent='...';

        const ctx=buildFinCtx();
        const prompt=`당신은 개인 재무 상담사입니다. 이 이미지를 분석하세요.

고지서/청구서/영수증/은행명세서/카드내역 등 금융 문서라면:
- 항목명, 금액, 납기일, 입금/출금 여부를 추출하세요
- 정기 항목이면 등록 액션을 추가하세요

${ctx}

[액션 형식]
등록: [ACTION]{"act":"add","name":"항목명","amount":금액,"txType":"입금또는출금","cycle":"daily또는weekly또는monthly또는none","day":숫자}[/ACTION]

분석 결과를 간결하게 요약하고, 등록 가능한 항목이 있으면 액션 태그를 추가하세요.`;

        try{
            const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key='+key,{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[
                    {text:prompt},
                    {inline_data:{mime_type:mime,data:base64}}
                ]}]})
            });
            const d=await r.json();
            let reply=d?.candidates?.[0]?.content?.parts?.[0]?.text||d?.error?.message||'분석 실패';
            const actionMatches=[...reply.matchAll(/\[ACTION\](.*?)\[\/ACTION\]/g)];
            for(const m of actionMatches){
                try{await executeAiAction(JSON.parse(m[1]))}catch(e){}
            }
            if(actionMatches.length)reply=reply.replace(/\[ACTION\].*?\[\/ACTION\]/g,'').trim();
            aiMessages[aiMessages.length-1].text=reply;
        }catch(e){
            aiMessages[aiMessages.length-1].text='오류: '+e.message;
        }
        btn.disabled=false;btn.textContent='AI';
        renderAiMsgs();
        input.value='';
    };
    reader.readAsDataURL(file);
}

async function executeAiAction(act){
    if(act.act==='add'){
        // 중복 방지: 같은 이름+금액+타입+주기 항목이 이미 있으면 스킵
        const dup=settleManual.find(m=>m.name===(act.name||'항목')&&m.amount===(act.amount||0)&&m.type===(act.txType||'입금')&&m.cycle===(act.cycle||'daily'));
        if(dup){aiMessages[aiMessages.length-1].text+=' (이미 등록됨, 중복 스킵)';return}
        const entry={name:act.name||'항목',amount:act.amount||0,type:act.txType||'입금',cycle:act.cycle||'daily',ts:Date.now()};
        if(act.cycle==='weekly')entry.dayOfWeek=act.day||0;
        else if(act.cycle==='monthly')entry.dayOfMonth=act.day||1;
        const id='sm_'+Date.now();
        await fetch(FB+'/banktotal/settle/manual/'+id+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(entry)});
    }else if(act.act==='del'){
        const targets=settleManual.filter(m=>m.name===act.name||m.name.includes(act.name)||act.name.includes(m.name));
        for(const t of targets){
            await fetch(FB+'/banktotal/settle/manual/'+t._id+'.json',{method:'DELETE'});
        }
        if(targets.length)aiMessages[aiMessages.length-1].text+=' ('+targets.length+'건 삭제)';
    }else if(act.act==='add_rule'){
        const rules=aiRules.rules||[];
        rules.push(act.rule);
        await fetch(FB+'/banktotal/ai_rules/rules.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(rules)});
        aiRules.rules=rules;
    }else if(act.act==='del_rule'){
        const rules=(aiRules.rules||[]).filter(r=>r!==act.rule);
        await fetch(FB+'/banktotal/ai_rules/rules.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(rules)});
        aiRules.rules=rules;
    }else if(act.act==='set_info'){
        const val=act.value;
        await fetch(FB+'/banktotal/ai_rules/'+act.key+'.json',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(val)});
        aiRules[act.key]=val;
    }
}

function delAiMsg(i){aiMessages.splice(i,1);renderAiMsgs();}
function clearAiMsgs(){aiMessages=[];renderAiMsgs();}
function renderAiMsgs(){
    const el=document.getElementById('aiMsgs');if(!el)return;
    let h=aiMessages.length>1?'<div style="text-align:right;padding:2px 4px"><span onclick="clearAiMsgs()" style="font-size:10px;color:#707088;cursor:pointer">전체삭제</span></div>':'';
    h+=aiMessages.map((m,i)=>`<div class="ai-msg ${m.role}" style="position:relative">${m.text.replace(/\n/g,'<br>')}<span onclick="event.stopPropagation();delAiMsg(${i})" style="position:absolute;top:2px;right:6px;font-size:10px;color:#70708899;cursor:pointer">✕</span></div>`).join('');
    el.innerHTML=h;
    el.scrollTop=el.scrollHeight;
}

// --- 새로고침 ---
function doRefresh(){
    const btn=document.getElementById('refreshBtn');
    btn.classList.add('spinning');
    setTimeout(()=>btn.classList.remove('spinning'),600);
    // 웹페이지 자체를 최신 버전으로 리로드
    location.reload(true);
}

// --- 초기화 ---
window.onload=function(){
    if(typeof NativeBridge!=='undefined'){
        loadFromNative();
        // 네이티브에서도 Firebase SSE로 거래/로그 데이터 로드
        initSSE();
    }else{
        initSSE();
    }
    renderPermissions();
    loadAiKey();

    // 앱에서 호출할 수 있는 리프레시 함수
    window.refreshFromNative=function(){loadFromNative();};
};
</script>
</body>
</html>
